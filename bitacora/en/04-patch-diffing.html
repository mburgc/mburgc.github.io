<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 4: Patch Diffing | Bitácora Red Team</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&family=Source+Code+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {
    /* Hacker Red Team Color Palette */
    --crimson-dark: #8B0000;
    --crimson: #DC143C;
    --crimson-light: #FF2442;
    --crimson-glow: rgba(220, 20, 60, 0.6);
    
    /* Grays */
    --gray-900: #0a0a0a;
    --gray-800: #1a1a1a;
    --gray-700: #2d2d2d;
    --gray-600: #404040;
    --gray-500: #525252;
    --gray-400: #737373;
    --gray-300: #a3a3a3;
    --gray-200: #d4d4d4;
    --gray-100: #f5f5f5;
    --white: #ffffff;
    
    /* Accent colors */
    --accent-red: #ff4444;
    --accent-orange: #ff6b35;
    --matrix-green: #00ff41;
    --terminal-green: #39ff14;
    
    /* Typography */
    --font-mono: 'Fira Code', 'JetBrains Mono', 'Source Code Pro', monospace;
    
    /* Sizing */
    --sidebar-width: 280px;
    --header-height: 70px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-mono);
    background: var(--gray-900);
    color: var(--gray-200);
    line-height: 1.8;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Background with cover image */
.page-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2;
    background: 
        linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.9) 50%, rgba(45, 45, 45, 0.85) 100%),
        url('images/image-000.jpg');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
}

/* Scanline effect */
.page-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 3px
    );
    pointer-events: none;
    animation: scanlines 10s linear infinite;
}

@keyframes scanlines {
    0% { transform: translateY(0); }
    100% { transform: translateY(3px); }
}

/* Matrix rain effect (subtle) */
.matrix-rain {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0.03;
    background: 
        linear-gradient(180deg, transparent 0%, var(--crimson) 100%),
        repeating-linear-gradient(
            0deg,
            transparent 0px,
            transparent 40px,
            var(--accent-red) 40px,
            var(--accent-red) 42px
        );
}

/* Header */
.main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: linear-gradient(180deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.95) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(220, 20, 60, 0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--white);
    box-shadow: 0 0 20px var(--crimson-glow);
}

.logo-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--white);
    letter-spacing: 1px;
}

.logo-text span {
    color: var(--crimson);
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 20px;
}

.search-container {
    position: relative;
}

.search-input {
    background: rgba(45, 45, 45, 0.8);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    padding: 8px 15px;
    padding-right: 40px;
    color: var(--gray-200);
    font-family: var(--font-mono);
    font-size: 0.85rem;
    width: 220px;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--crimson);
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.3);
    width: 280px;
}

.search-input::placeholder {
    color: var(--gray-500);
}

.search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    transition: color 0.3s ease;
}

.search-btn:hover {
    color: var(--crimson);
}

.language-switch {
    display: flex;
    align-items: center;
    gap: 10px;
}

.lang-btn {
    background: transparent;
    border: 1px solid var(--gray-600);
    color: var(--gray-300);
    padding: 6px 14px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.lang-btn:hover, .lang-btn.active {
    background: var(--crimson);
    border-color: var(--crimson);
    color: var(--white);
    box-shadow: 0 0 15px var(--crimson-glow);
}

.menu-toggle {
    display: none;
    background: transparent;
    border: 1px solid var(--gray-600);
    color: var(--gray-200);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
}

/* Sidebar */
.sidebar {
    position: fixed;
    top: var(--header-height);
    left: 0;
    width: var(--sidebar-width);
    height: calc(100vh - var(--header-height));
    background: linear-gradient(180deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.95) 100%);
    border-right: 1px solid rgba(220, 20, 60, 0.2);
    overflow-y: auto;
    z-index: 900;
    padding: 30px 20px;
    transition: transform 0.3s ease;
}

.sidebar::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track {
    background: var(--gray-800);
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--gray-600);
    border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--crimson);
}

.sidebar-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--gray-500);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(220, 20, 60, 0.2);
}

.toc-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    color: var(--gray-300);
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.toc-link:hover {
    background: rgba(220, 20, 60, 0.1);
    color: var(--white);
    transform: translateX(5px);
}

.toc-link.active {
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.2) 0%, rgba(220, 20, 60, 0.1) 100%);
    color: var(--crimson);
    border-left: 3px solid var(--crimson);
}

.chapter-num {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--crimson);
    background: rgba(220, 20, 60, 0.1);
    padding: 4px 8px: 4px;
    min-width;
    border-radius: 30px;
    text-align: center;
}

.chapter-title {
    flex: 1;
    line-height: 1.3;
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 850;
}

/* Main content */
.main-content {
    margin-left: var(--sidebar-width);
    margin-top: var(--header-height);
    min-height: calc(100vh - var(--header-height));
    padding: 40px 50px;
}

.content-wrapper {
    max-width: 900px;
    margin: 0 auto;
}

/* Content area styling */
.content-area {
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(45, 45, 45, 0.9) 100%);
    border: 1px solid rgba(220, 20, 60, 0.2);
    border-radius: 16px;
    padding: 50px;
    box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(220, 20, 60, 0.1);
    backdrop-filter: blur(10px);
}

.content-area h1 {
    font-size: 2.2rem;
    color: var(--white);
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--crimson);
    text-shadow: 0 0 20px var(--crimson-glow);
}

.content-area h2 {
    font-size: 1.6rem;
    color: var(--crimson);
    margin-top: 40px;
    margin-bottom: 20px;
    padding-left: 15px;
    border-left: 3px solid var(--crimson);
}

.content-area h3 {
    font-size: 1.3rem;
    color: var(--gray-100);
    margin-top: 30px;
    margin-bottom: 15px;
}

.content-area h4 {
    font-size: 1.1rem;
    color: var(--gray-300);
    margin-top: 25px;
    margin-bottom: 10px;
}

.content-area p {
    margin-bottom: 20px;
    color: var(--gray-200);
    text-align: justify;
}

.content-area a {
    color: var(--crimson);
    text-decoration: none;
    transition: all 0.3s ease;
    border-bottom: 1px solid transparent;
}

.content-area a:hover {
    color: var(--crimson-light);
    border-bottom-color: var(--crimson-light);
    text-shadow: 0 0 10px var(--crimson-glow);
}

.content-area ul, .content-area ol {
    margin-bottom: 20px;
    padding-left: 30px;
}

.content-area li {
    margin-bottom: 10px;
    color: var(--gray-200);
}

.content-area li::marker {
    color: var(--crimson);
}

/* Code blocks */
.content-area code {
    font-family: var(--font-mono);
    background: rgba(220, 20, 60, 0.1);
    color: var(--crimson-light);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}

.content-area pre {
    background: var(--gray-900);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
}

.content-area pre code {
    background: none;
    padding: 0;
    color: var(--terminal-green);
    font-size: 0.85rem;
    line-height: 1.6;
}

/* Tables */
.content-area table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9rem;
}

.content-area th {
    background: linear-gradient(135deg, var(--crimson-dark) 0%, var(--crimson) 100%);
    color: var(--white);
    padding: 15px;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.8rem;
}

.content-area td {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(220, 20, 60, 0.1);
    color: var(--gray-200);
}

.content-area tr:hover {
    background: rgba(220, 20, 60, 0.05);
}

.content-area tr:nth-child(even) {
    background: rgba(45, 45, 45, 0.3);
}

/* Search highlight */
.search-highlight {
    background: var(--crimson);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 3px;
    box-shadow: 0 0 10px var(--crimson-glow);
}

.no-results {
    text-align: center;
    padding: 40px;
    color: var(--gray-400);
    font-size: 1.1rem;
    display: none;
}

.no-results i {
    font-size: 2rem;
    margin-bottom: 15px;
    color: var(--crimson);
}

/* Navigation buttons */
.nav-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 1px solid rgba(220, 20, 60, 0.2);
}

.nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 25px;
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.2) 0%, rgba(220, 20, 60, 0.1) 100%);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    color: var(--gray-200);
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%);
    border-color: var(--crimson);
    color: var(--white);
    box-shadow: 0 0 20px var(--crimson-glow);
    transform: translateY(-2px);
}

.nav-btn i {
    transition: transform 0.3s ease;
}

.nav-btn:hover i {
    transform: scale(1.2);
}

.nav-prev i {
    margin-right: 5px;
}

.nav-next i {
    margin-left: 5px;
}

.nav-home {
    background: linear-gradient(135deg, rgba(45, 45, 45, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
    border-color: var(--gray-600);
}

.nav-home:hover {
    background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
    border-color: var(--gray-400);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
}

/* Footer */
.page-footer {
    text-align: center;
    padding: 30px;
    color: var(--gray-500);
    font-size: 0.8rem;
    border-top: 1px solid rgba(220, 20, 60, 0.1);
    margin-top: 50px;
}

.page-footer a {
    color: var(--crimson);
    text-decoration: none;
}

.page-footer a:hover {
    text-shadow: 0 0 10px var(--crimson-glow);
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

@keyframes glow {
    0%, 100% {
        box-shadow: 0 0 20px var(--crimson-glow);
    }
    50% {
        box-shadow: 0 0 40px var(--crimson-glow), 0 0 60px var(--crimson-glow);
    }
}

.logo-icon {
    animation: glow 3s ease-in-out infinite;
}

/* Responsive */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .sidebar-overlay.active {
        display: block;
    }
    
    .main-content {
        margin-left: 0;
        padding: 30px 20px;
    }
    
    .menu-toggle {
        display: block;
    }
    
    .search-input {
        width: 150px;
    }
    
    .search-input:focus {
        width: 200px;
    }
}

@media (max-width: 768px) {
    .main-header {
        padding: 0 15px;
    }
    
    .logo-text {
        display: none;
    }
    
    .search-container {
        display: none;
    }
    
    .language-switch {
        gap: 5px;
    }
    
    .lang-btn {
        padding: 5px 10px;
        font-size: 0.65rem;
    }
    
    .content-area {
        padding: 30px 20px;
    }
    
    .content-area h1 {
        font-size: 1.6rem;
    }
    
    .content-area h2 {
        font-size: 1.3rem;
    }
    
    .content-area h3 {
        font-size: 1.1rem;
    }
    
    .nav-buttons {
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .nav-btn {
        flex: 1;
        justify-content: center;
        min-width: 100px;
    }
}

@media (max-width: 480px) {
    .content-area {
        padding: 20px 15px;
        border-radius: 12px;
    }
    
    .content-area h1 {
        font-size: 1.4rem;
    }
    
    .nav-buttons {
        flex-direction: column;
    }
    
    .nav-btn {
        width: 100%;
        justify-content: center;
    }
}

/* Print styles */
@media print {
    .page-background,
    .matrix-rain,
    .sidebar,
    .main-header,
    .nav-buttons {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
        padding: 0;
    }
    
    .content-area {
        box-shadow: none;
        border: 1px solid #ccc;
    }
}
</style>
</head>
<body>
    <div class="page-background"></div>
    <div class="matrix-rain"></div>
    
    <!-- Header -->
    <header class="main-header">
        <div class="logo">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo-icon">
                <i class="fas fa-skull"></i>
            </div>
            <div class="logo-text">
                RED<span>TEAM</span> LOG
            </div>
        </div>
        
        <div class="header-controls">
            <div class="search-container">
                <input type="text" class="search-input" id="searchbar" placeholder="Search content...">
                <button class="search-btn" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="language-switch">
                <a href="../es/04-patch-diffing.html" class="lang-btn">Español</a>
            </div>
        </div>
    </header>
    
    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-title">Chapters</div>
        <a href="01-introduction.html" class="toc-link ">
            <span class="chapter-num">01</span>
            <span class="chapter-title">Introduction</span>
        </a><a href="02-vulnerability-classes.html" class="toc-link ">
            <span class="chapter-num">02</span>
            <span class="chapter-title">Vulnerability Classes</span>
        </a><a href="03-fuzzing.html" class="toc-link ">
            <span class="chapter-num">03</span>
            <span class="chapter-title">Fuzzing</span>
        </a><a href="04-patch-diffing.html" class="toc-link active">
            <span class="chapter-num">04</span>
            <span class="chapter-title">Patch Diffing</span>
        </a><a href="05-crash-analysis.html" class="toc-link ">
            <span class="chapter-num">05</span>
            <span class="chapter-title">Crash Analysis</span>
        </a>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <article class="content-area">
                <h1>Chapter 4: Patch Diffing</h1>
<p>"Patch Diffing" is the process of comparing two versions of a program, one with a security patch and one without, to identify the vulnerability that the patch corrects. It is a crucial technique for security researchers who want to understand how a vulnerability works and how to exploit it.</p>
<h2>4.1. Patch Diffing Fundamentals</h2>
<p><strong>The Process:</strong></p>
<ol>
<li><strong>Obtain the Binaries:</strong> You need both versions of the binary: the vulnerable one and the patched one.</li>
<li><strong>Differentiate the Binaries:</strong> A binary diffing tool (like <code>bindiff</code>, <code>Ghidra</code>, or <code>IDA Pro</code>) is used to compare the two files.</li>
<li><strong>Analyze the Differences:</strong> The researcher analyzes the functions that have changed to identify the vulnerability.</li>
<li><strong>Develop a PoC:</strong> Once the vulnerability is understood, a proof of concept (PoC) can be developed to demonstrate it.</li>
</ol>
<h2>4.2. Extracting Windows Patches</h2>
<p>In Windows, security patches are distributed as MSU files. These files can be extracted to obtain the updated binaries.</p>
<p><strong>PowerShell Extraction Script (Extract-Patch.ps1):</strong></p>
<p>A PowerShell script can automate the process of downloading and extracting Windows Update patches.</p>
<h2>4.3. Binary Diffing Tools</h2>
<ul>
<li><strong>Ghidra and Ghidriff:</strong> Ghidra is a software reverse engineering framework from the NSA. Ghidriff is a Ghidra extension that facilitates binary diffing.</li>
<li><strong>BinDiff:</strong> A popular diffing tool for IDA Pro.</li>
<li><strong>Ghidra's Version Tracking:</strong> Ghidra also has a built-in "version tracking" feature that can be used to compare binaries.</li>
</ul>
<h2>4.4. Case Study: CVE-2022-34718 (EvilESP)</h2>
<p>This case study shows how patch diffing was used to analyze a vulnerability in the Windows ESP protocol. The analysis revealed an error in the handling of fragmented ESP packets that could lead to remote code execution.</p>
<h3>CVE Information:</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE</td>
<td>CVE-2022-34718</td>
</tr>
<tr>
<td>Name</td>
<td>"EvilESP"</td>
</tr>
<tr>
<td>Component</td>
<td>tcpip.sys (Windows TCP/IP Driver)</td>
</tr>
<tr>
<td>Type</td>
<td>Remote Code Execution (RCE)</td>
</tr>
<tr>
<td>CVSS</td>
<td>9.8 (Critical)</td>
</tr>
<tr>
<td>Vector</td>
<td>Network, unauthenticated (with IPsec enabled)</td>
</tr>
<tr>
<td>Versions</td>
<td>Windows Server 2012-2022, Windows 10/11</td>
</tr>
<tr>
<td>Patch</td>
<td>September 2022 (KB5017308, KB5017305)</td>
</tr>
</tbody>
</table>
<h3>Prerequisites for Exploitation:</h3>
<table>
<thead>
<tr>
<th>Prerequisite</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>IPv6 enabled</td>
<td>Default on Windows</td>
</tr>
<tr>
<td>IPsec enabled and SA established</td>
<td></td>
</tr>
<tr>
<td>Attacker knows SPI + HMAC key</td>
<td>From the victim</td>
</tr>
<tr>
<td>Attacker can send IPv6 packets</td>
<td>To the victim</td>
</tr>
</tbody>
</table>
<h3>4.4.1. Acquiring Binaries for EvilESP</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Create working directory</span>
<span class="n">mkdir</span> <span class="n">C</span><span class="p">:\</span><span class="n">EvilESP-Analysis</span>
<span class="nb">cd </span><span class="n">C</span><span class="p">:\</span><span class="n">EvilESP-Analysis</span>

<span class="c"># Get vulnerable tcpip.sys (pre-September 2022)</span>
<span class="c"># WinbIndex: https://winbindex.m417z.com/ → tcpip.sys → KB5016616</span>

<span class="c"># Get patched tcpip.sys (September 2022+)</span>
<span class="c"># WinbIndex → KB5017308 (Server 2022) or KB5017305 (Win 10/11)</span>

<span class="c"># Download symbols</span>
<span class="nv">$symchk</span> <span class="p">=</span> <span class="s2">&quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\symchk.exe&quot;</span>
<span class="p">&amp;</span> <span class="nv">$symchk</span> <span class="n">tcpip_vulnerable</span><span class="p">.</span><span class="n">sys</span> <span class="p">/</span><span class="n">s</span> <span class="s2">&quot;SRV*.\Symbols*https://msdl.microsoft.com/download/symbols&quot;</span>
</code></pre></div>

<h3>4.4.2. Running Diff and Analysis</h3>
<div class="codehilite"><pre><span></span><code><span class="n">ghidriff</span> <span class="n">tcpip_vulnerable</span><span class="p">.</span><span class="n">sys</span> <span class="n">tcpip_patched</span><span class="p">.</span><span class="n">sys</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-symbols-path</span> <span class="p">.\</span><span class="n">Symbols</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-max-section-funcs</span> <span class="n">5000</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-output</span> <span class="n">tcpip_diff</span>

<span class="c"># Expected: Only 2 functions changed</span>
<span class="c"># - IppReceiveEsp</span>
<span class="c"># - Ipv6pReassembleDatagram</span>
</code></pre></div>

<h3>4.4.3. Vulnerable vs Patched Code Analysis</h3>
<p><strong>Function 1: IppReceiveEsp</strong></p>
<p>Vulnerable Code:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">IppReceiveEsp</span><span class="p">(</span><span class="n">longlong</span><span class="w"> </span><span class="n">param_1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">iVar3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IppReceiveEspNbl</span><span class="p">(...);</span>

<span class="w">    </span><span class="c1">// BUG: Only checks 0 (success) or 0x105 (pending)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">iVar3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x105</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">undefined4</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="n">longlong</span><span class="p">)</span><span class="n">param_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x2c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3b</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Patched Code:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">IppReceiveEsp</span><span class="p">(</span><span class="n">longlong</span><span class="w"> </span><span class="n">param_1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">iVar3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IppReceiveEspNbl</span><span class="p">(...);</span>

<span class="w">    </span><span class="c1">// FIX 1: Complete range verification</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">iVar3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x2b</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// FIX 2: Discard invalid packets</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x105</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">puVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">IppDiscardReceivedPackets</span><span class="p">(</span>
<span class="w">                </span><span class="p">(</span><span class="n">longlong</span><span class="p">)</span><span class="n">puVar3</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">param_1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0004148</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Function 2: Ipv6pReassembleDatagram</strong></p>
<p>Vulnerable Code:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Ipv6pReassembleDatagram</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uVar11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x8c</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// BUG 1: No 16-bit overflow check</span>
<span class="w">    </span><span class="c1">// BUG 2: No nextheader_offset validation</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">uVar13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">puVar5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x80</span><span class="p">),</span>
<span class="w">               </span><span class="p">(</span><span class="n">ulonglong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Patched Code:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Ipv6pReassembleDatagram</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uVar11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x8c</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// FIX 1: Check 16-bit overflow</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar14</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10001</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// FIX 2: Validate nextheader_offset</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uVar13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// FIX 3: Check final size</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">lVar4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Log failure</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>4.4.4. Attack Flow</h3>
<ol>
<li>Attacker creates malicious IPv6 packets with ESP header and fragments causing overflow</li>
<li>Packet 1: Fragment with offset=0, M=1</li>
<li>Packet 2: Fragment with offset=24, M=0 (triggers reassembly)</li>
<li>IppReceiveEsp() doesn't correctly validate return code</li>
<li>Ipv6pReassembleDatagram() doesn't check overflow or nextheader_offset</li>
<li>memcpy OOB → memory corruption → RCE or BSOD</li>
</ol>
<h3>4.4.5. ESP Packet Structure</h3>
<p><strong>ESP Header (RFC 4303):</strong>
- SPI (4 bytes)
- Sequence Number (4 bytes)
- Payload Data (variable)
- Padding + Pad Length + Next Header</p>
<p><strong>IPv6 Fragment Header:</strong>
- Next Header (1 byte)
- Fragment Offset (13 bits) + Flags
- Identification (4 bytes)</p>
<h3>4.4.6. Exploitation Primitive</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Type</td>
<td>Out-of-bounds write</td>
</tr>
<tr>
<td>Size</td>
<td>Variable</td>
</tr>
<tr>
<td>Offset Control</td>
<td>Via nextheader_offset</td>
</tr>
<tr>
<td>Trigger</td>
<td>Remote, requires IPsec SA</td>
</tr>
<tr>
<td>Prerequisite</td>
<td>IPv6 enabled, IPsec running</td>
</tr>
</tbody>
</table>
<h3>4.4.7. Patch Summary</h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Vulnerability</th>
<th>Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>IppReceiveEsp</td>
<td>Missing validation</td>
<td>Range check</td>
</tr>
<tr>
<td>IppReceiveEsp</td>
<td>Continue on error</td>
<td>IppDiscardReceivedPackets</td>
</tr>
<tr>
<td>Ipv6pReassembleDatagram</td>
<td>Integer overflow</td>
<td>Check: uVar14 &lt; 0x10001</td>
</tr>
<tr>
<td>Ipv6pReassembleDatagram</td>
<td>OOB offset</td>
<td>Check: offset &lt;= buffer</td>
</tr>
</tbody>
</table>
<h3>4.4.8. Lessons</h3>
<ol>
<li>Binary diffing is effective: 10,000+ functions → only 2 changed</li>
<li>Protocol knowledge is essential</li>
<li>Simple bugs have high impact (CVSS 9.8)</li>
<li>Multi-function vulnerabilities are common</li>
<li>Prerequisites limit real risk</li>
<li>Patches reveal trigger conditions</li>
</ol>
<h2>4.5. Patch Diffing Automation Pipeline</h2>
<h3>Why Automate?</h3>
<ul>
<li>Microsoft releases patches monthly (Patch Tuesday - 2nd Tuesday of each month).</li>
<li>Analyzing each update manually is time-consuming.</li>
<li>Early detection of vulnerabilities provides a competitive advantage.</li>
<li>Automation allows for continuous monitoring.</li>
</ul>
<h3>Pipeline Stages:</h3>
<ol>
<li><strong>MONITOR:</strong> MSRC API, Patch Tuesday</li>
<li><strong>DOWNLOAD:</strong> WinbIndex, Update Catalog</li>
<li><strong>EXTRACT:</strong> Expand MSU, Extract CAB</li>
<li><strong>SYMBOLS:</strong> symchk.exe, Symbol Server</li>
<li><strong>DIFF:</strong> Ghidriff, BinDiff</li>
<li><strong>REPORT:</strong> HTML/PDF, JSON for CI</li>
<li><strong>ALERT:</strong> Email, Ticket, Slack/Teams</li>
</ol>
<h3>Python Automation Script for Ghidriff</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PatchDiffer</span><span class="p">:</span>
    <span class="c1"># ... (script implementation)</span>
</code></pre></div>

<h2>4.6. Patch Diffing in the Linux Kernel</h2>
<h3>4.6.1. Differences from Windows</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Windows</th>
<th>Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td>Source Code</td>
<td>Closed (binaries only)</td>
<td>Open (git.kernel.org)</td>
</tr>
<tr>
<td>Binary Format</td>
<td>PE/COFF</td>
<td>ELF</td>
</tr>
<tr>
<td>Debug Symbols</td>
<td>PDB via Symbol Server</td>
<td>DWARF in -dbgsym packages</td>
</tr>
<tr>
<td>Distribution</td>
<td>Windows Update</td>
<td>apt/yum + distro-specific</td>
</tr>
<tr>
<td>Vendor Modifications</td>
<td>None</td>
<td>Backports, custom patches</td>
</tr>
</tbody>
</table>
<h3>4.6.2. Linux Workflow</h3>
<ol>
<li><strong>Identify Kernel Versions</strong></li>
<li><strong>Download Kernel Images and Symbols</strong></li>
<li><strong>Extract vmlinux</strong></li>
<li><strong>Identify Changed Modules</strong></li>
<li><strong>Diff with Ghidriff</strong></li>
</ol>
<h3>4.6.3. Source Code Level Diff</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Clone the kernel source</span>
git<span class="w"> </span>clone<span class="w"> </span>--branch<span class="w"> </span>v6.8<span class="w"> </span>https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
<span class="nb">cd</span><span class="w"> </span>linux

<span class="c1"># Search for CVE commits</span>
git<span class="w"> </span>log<span class="w"> </span>--all<span class="w"> </span>--grep<span class="o">=</span><span class="s2">&quot;CVE&quot;</span><span class="w"> </span>--oneline<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-20

<span class="c1"># View the diff of a specific commit</span>
git<span class="w"> </span>show<span class="w"> </span>f342de4e2f33e0e39165d8639387aa6c19dff660
</code></pre></div>

<h3>4.6.4. Example: CVE-2024-1086 (nf_tables UAF)</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE</td>
<td>CVE-2024-1086</td>
</tr>
<tr>
<td>Component</td>
<td>nf_tables (Netfilter subsystem)</td>
</tr>
<tr>
<td>Type</td>
<td>Use-After-Free → LPE</td>
</tr>
<tr>
<td>CVSS</td>
<td>7.8 (High)</td>
</tr>
<tr>
<td>Affected</td>
<td>Linux 3.15 - 6.8</td>
</tr>
<tr>
<td>Public Exploit</td>
<td>Yes (~99% success rate)</td>
</tr>
</tbody>
</table>
<p><strong>Bug Analysis:</strong>
- Mask-based validation allowed values like NF_DROP | extra_bits
- &amp; NF_VERDICT_MASK passed through "decorated" verdicts
- Type confusion → UAF → LPE
- Fix: Changed from mask validation to exact match</p>
<h3>4.6.5. Linux Kernel Resources</h3>
<table>
<thead>
<tr>
<th>Resource</th>
<th>URL</th>
<th>Usefulness</th>
</tr>
</thead>
<tbody>
<tr>
<td>syzbot</td>
<td>syzkaller.appspot.com</td>
<td>Reproducers, auto-bisection</td>
</tr>
<tr>
<td>Ubuntu Security Notices</td>
<td>ubuntu.com/security/notices</td>
<td>Distro advisories</td>
</tr>
<tr>
<td>kernel.org</td>
<td>git.kernel.org</td>
<td>Official source code</td>
</tr>
</tbody>
</table>
<h2>4.7. Case Study: 7-Zip Path Traversal</h2>
<h3>4.7.1. Case Information</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Software</td>
<td>7-Zip File Archiver</td>
</tr>
<tr>
<td>Affected Versions</td>
<td>24.09 and earlier</td>
</tr>
<tr>
<td>Type</td>
<td>Path Traversal via Symlink (CWE-22)</td>
</tr>
<tr>
<td>Impact</td>
<td>Arbitrary File Write → potential RCE</td>
</tr>
<tr>
<td>CVSS</td>
<td>7.8 (High)</td>
</tr>
</tbody>
</table>
<h3>4.7.2. Patch Analysis</h3>
<p>File: <code>CPP/7zip/UI/Common/ArchiveExtractCallback.cpp</code></p>
<p><strong>Change 1: IsSafePath with WSL Parameter</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// BEFORE: bool IsSafePath(const UString &amp;path)</span>
<span class="c1">// AFTER: static bool IsSafePath(const UString &amp;path, bool isWSL)</span>
</code></pre></div>

<p><strong>Change 2: WSL-Aware Detection</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// BEFORE: IsAbsolute = NName::IsAbsolutePath(path);</span>
<span class="c1">// AFTER: IsAbsolute = isWSL ? IS_PATH_SEPAR(path[0]) : NName::IsAbsolutePath(path);</span>
</code></pre></div>

<h3>4.7.3. Attack Scenario</h3>
<ol>
<li>Create file with WSL symlink: <code>link -&gt; /mnt/c/Users/Public/Desktop</code></li>
<li>7-Zip 24.09: IsSafePath() without isWSL=true → classifies as "relative"</li>
<li>Symlink created outside extraction directory</li>
<li>→ Arbitrary File Write → RCE via DLL hijacking</li>
</ol>
<h3>4.7.4. Path Validation Checklist</h3>
<p><strong>Search:</strong> IsSafePath, ValidatePath, IsAbsolute, IsRelative, symlinks</p>
<p><strong>Verify:</strong>
- Is cross-platform detection correct?
- Are WSL/Linux symlinks handled with proper semantics?
- Is normalization done before validation?</p>
<h2>4.8. Chapter 4 Conclusions</h2>
<ol>
<li>
<p><strong>The patch is often the only source of truth</strong> when CVE details are limited.</p>
</li>
<li>
<p><strong>Tools automate but don't replace human analysis</strong> - Ghidriff finds changed functions, you understand why.</p>
</li>
<li>
<p><strong>Symbols are force multipliers</strong> - With PDBs you see <code>IppValidatePacketLength</code>; without them, you see <code>sub_1400A2F40</code>.</p>
</li>
<li>
<p><strong>Fix patterns reveal vulnerability classes:</strong></p>
</li>
<li>Bounds checks → overflow/OOB</li>
<li>Initialization → uninitialized memory</li>
<li>Locks → race condition</li>
<li>
<p>Input validation → input validation flaw</p>
</li>
<li>
<p><strong>Patch diffing finds variants</strong> - When analyzing a fix, similar bugs in nearby code are often discovered.</p>
</li>
<li>
<p><strong>Cross-platform analysis requires knowledge of both semantics</strong> - As seen in 7-Zip.</p>
</li>
<li>
<p><strong>Automation transforms analysis from reactive to proactive</strong>.</p>
</li>
</ol>
<h3>Discussion Questions:</h3>
<ol>
<li>
<p>CVE-2022-34718 requires IPsec SA but received CVSS 9.8. How should prerequisites affect rating?</p>
</li>
<li>
<p>EvilESP bug spanned two functions. How could you detect cross-function vulnerabilities?</p>
</li>
<li>
<p>IPv6 fragmentation is a recurring source of errors. What makes it prone to bugs?</p>
</li>
<li>
<p>7-Zip fix added multiple changes. How do you determine which corrects the core vulnerability?</p>
</li>
</ol>
            </article>
            
            <!-- Navigation -->
            <div class="nav-buttons">
                <a href="03-fuzzing.html" class="nav-btn nav-prev">
            <i class="fas fa-chevron-left"></i>
            <span>Previous</span>
        </a><a href="index.html" class="nav-btn nav-home">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a><a href="05-crash-analysis.html" class="nav-btn nav-next">
            <span>Next</span>
            <i class="fas fa-chevron-right"></i>
        </a>
            </div>
            
            <!-- Footer -->
            <footer class="page-footer">
                <p>© 2024 Red Team Logbook | <a href="https://github.com/mburgc/mburgc.github.io" target="_blank">
                    <i class="fab fa-github"></i> mburgc
                </a></p>
            </footer>
        </div>
    </main>
    
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchbar');
    const searchBtn = document.getElementById('search-btn');
    
    function performSearch() {
        let input = searchInput.value.toLowerCase().trim();
        let content = document.querySelector('.content-area');
        let paragraphs = content.getElementsByTagName('p');
        let lis = content.getElementsByTagName('li');
        let headers = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
        let codeBlocks = content.querySelectorAll('pre, code');
        
        let all_elements = [...paragraphs, ...lis, ...headers, ...codeBlocks];
        
        // Reset all elements first
        for (let i = 0; i < all_elements.length; i++) {
            let el = all_elements[i];
            el.style.display = '';
            if (el.classList.contains('highlight')) {
                el.classList.remove('highlight');
                el.innerHTML = el.textContent;
            }
        }
        
        if (input === "") {
            return;
        }
        
        for (let i = 0; i < all_elements.length; i++) {
            let element = all_elements[i];
            let text = element.textContent.toLowerCase();
            if (text.includes(input)) {
                element.style.display = "";
                let originalText = element.textContent;
                let escaped = input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                let newText = originalText.replace(new RegExp('(' + escaped + ')', 'gi'), '<span class="search-highlight">$1</span>');
                element.innerHTML = newText;
            } else {
                element.style.display = "none";
            }
        }
        
        // Show no results message
        let visibleCount = 0;
        for (let i = 0; i < all_elements.length; i++) {
            if (all_elements[i].style.display !== "none") visibleCount++;
        }
        
        let noResults = document.getElementById('no-results');
        if (visibleCount === 0) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.id = 'no-results';
                noResults.className = 'no-results';
                noResults.innerHTML = '<i class="fas fa-search"></i> No se encontraron resultados / No results found';
                content.insertBefore(noResults, content.firstChild);
            }
            noResults.style.display = 'block';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    }
    
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') performSearch();
            if (this.value === '') {
                let all_elements = document.querySelectorAll('.search-highlight');
                all_elements.forEach(el => {
                    let parent = el.parentNode;
                    parent.innerHTML = parent.textContent;
                });
                let noResults = document.getElementById('no-results');
                if (noResults) noResults.style.display = 'none';
            }
        });
    }
    
    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    if (menuToggle) {
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    
    // Scroll animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.content-area > *').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });
    
    // Trigger initial animation
    setTimeout(() => {
        document.querySelectorAll('.content-area > *').forEach((el, index) => {
            setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 50);
        });
    }, 100);
    
    // Table of contents highlighting
    const tocLinks = document.querySelectorAll('.toc-link');
    const contentHeaders = document.querySelectorAll('.content-area h1, .content-area h2, .content-area h3');
    
    window.addEventListener('scroll', () => {
        let current = '';
        contentHeaders.forEach(header => {
            const headerTop = header.offsetTop;
            if (window.pageYOffset >= headerTop - 100) {
                current = header.getAttribute('id');
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    });
});
</script>

</body>
</html>