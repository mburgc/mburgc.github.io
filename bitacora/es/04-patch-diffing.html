<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capítulo 4: Patch Diffing | Red Team Logbook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {--crimson:#DC143C;--crimson-dark:#8B0000;--crimson-glow:rgba(220,20,60,0.6);--gray-900:#0a0a0a;--gray-800:#1a1a1a;--gray-700:#2d2d2d;--gray-600:#404040;--gray-500:#525252;--gray-400:#737373;--gray-300:#a3a3a3;--gray-200:#d4d4d4;--white:#fff;--green:#39ff14;--mono:'Fira Code',monospace;--sidebar:280px;--header:70px;}
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:var(--mono);background:var(--gray-900);color:var(--gray-200);line-height:1.7;min-height:100vh;}
.bg {position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background:linear-gradient(135deg,rgba(10,10,10,0.95),rgba(26,26,26,0.9)),url('images/image-000.jpg');background-size:cover;background-position:center;}
.bg::before {content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.1) 0,rgba(0,0,0,0.1) 1px,transparent 1px,transparent 3px);}
.header {position:fixed;top:0;left:0;right:0;height:var(--header);background:linear-gradient(180deg,rgba(10,10,10,0.98),rgba(26,26,26,0.95));backdrop-filter:blur(10px);border-bottom:1px solid rgba(220,20,60,0.3);z-index:1000;display:flex;align-items:center;justify-content:space-between;padding:0 30px;}
.logo {display:flex;align-items:center;gap:15px;}
.logo-icon {width:40px;height:40px;background:linear-gradient(135deg,var(--crimson),var(--crimson-dark));border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--white);box-shadow:0 0 20px var(--crimson-glow);}
.logo-text {font-size:1.1rem;font-weight:600;color:var(--white);letter-spacing:1px;}
.logo-text span {color:var(--crimson);}
.home-btn {display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:rgba(45,45,45,0.8);border:1px solid var(--gray-600);border-radius:8px;color:var(--gray-300);text-decoration:none;transition:all 0.3s;margin-left:15px;}
.home-btn:hover {background:var(--crimson);border-color:var(--crimson);color:var(--white);box-shadow:0 0 15px var(--crimson-glow);}
.controls {display:flex;align-items:center;gap:20px;}
.search {position:relative;}
.search input {background:rgba(45,45,45,0.8);border:1px solid rgba(220,20,60,0.3);border-radius:8px;padding:8px 15px;padding-right:40px;color:var(--gray-200);font-family:var(--mono);font-size:0.85rem;width:200px;transition:all 0.3s;}
.search input:focus {outline:none;border-color:var(--crimson);box-shadow:0 0 15px rgba(220,20,60,0.3);width:260px;}
.search button {position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--gray-400);cursor:pointer;}
.search button:hover {color:var(--crimson);}
.lang-btn {background:transparent;border:1px solid var(--gray-600);color:var(--gray-300);padding:6px 14px;border-radius:6px;font-family:var(--mono);font-size:0.75rem;cursor:pointer;transition:all 0.3s;text-transform:uppercase;text-decoration:none;letter-spacing:1px;}
.lang-btn:hover {background:var(--crimson);border-color:var(--crimson);color:var(--white);box-shadow:0 0 15px var(--crimson-glow);}
.menu-btn {display:none;background:transparent;border:1px solid var(--gray-600);color:var(--gray-200);padding:8px 12px;border-radius:6px;cursor:pointer;}
@media(min-width:1025px){.menu-btn{display:none}}
.sidebar {position:fixed;top:var(--header);left:0;width:var(--sidebar);height:calc(100vh - var(--header));background:linear-gradient(180deg,rgba(10,10,10,0.98),rgba(26,26,26,0.95));border-right:1px solid rgba(220,20,60,0.2);overflow-y:auto;z-index:900;padding:30px 20px;transition:transform 0.3s ease;}
@media(max-width:1024px){.sidebar{transform:translateX(-100%)}.sidebar.active{transform:translateX(0)}}
.sidebar-title {font-size:0.7rem;text-transform:uppercase;letter-spacing:3px;color:var(--gray-500);margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid rgba(220,20,60,0.2);}
.toc-link {display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--gray-300);text-decoration:none;border-radius:8px;margin-bottom:8px;transition:all 0.3s;font-size:0.85rem;}
.toc-link:hover {background:rgba(220,20,60,0.1);color:var(--white);transform:translateX(5px);}
.toc-link.active {background:linear-gradient(135deg,rgba(220,20,60,0.2),rgba(220,20,60,0.1));color:var(--crimson);border-left:3px solid var(--crimson);}
.chapter-num {font-size:0.7rem;font-weight:700;color:var(--crimson);background:rgba(220,20,60,0.1);padding:4px 8px;border-radius:30px;}
.chapter-title {flex:1;}
.overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:850;}
@media(max-width:1024px){.overlay.active{display:block}}
.content {margin-left:var(--sidebar);margin-top:var(--header);min-height:calc(100vh - var(--header));padding:40px 50px;}
@media(max-width:1024px){.content{margin-left:0}}
.wrapper {max-width:900px;margin:0 auto;}
.article {background:linear-gradient(135deg,rgba(26,26,26,0.95),rgba(45,45,45,0.9));border:1px solid rgba(220,20,60,0.2);border-radius:16px;padding:50px;box-shadow:0 10px 40px rgba(0,0,0,0.5),0 0 30px rgba(220,20,60,0.1);}
.article h1 {font-size:2.2rem;color:var(--white);margin-bottom:30px;padding-bottom:15px;border-bottom:2px solid var(--crimson);}
.article h2 {font-size:1.6rem;color:var(--crimson);margin-top:40px;margin-bottom:20px;padding-left:15px;border-left:3px solid var(--crimson);}
.article h3 {font-size:1.3rem;color:var(--gray-100);margin-top:30px;margin-bottom:15px;}
.article p {margin-bottom:20px;color:var(--gray-200);text-align:justify;}
.article a {color:var(--crimson);text-decoration:none;transition:all 0.3s;border-bottom:1px solid transparent;}
.article a:hover {color:#ff4444;border-bottom-color:#ff4444;}
.article ul,.article ol {margin-bottom:20px;padding-left:30px;}
.article li {margin-bottom:10px;}
.article code {font-family:var(--mono);background:rgba(220,20,60,0.1);color:#ff4444;padding:2px 8px;border-radius:4px;font-size:0.9em;}
.article pre {background:var(--gray-900);border:1px solid rgba(220,20,60,0.3);border-radius:8px;padding:20px;overflow-x:auto;margin:20px 0;}
.article pre code {background:none;padding:0;color:var(--green);}
.article table {width:100%;border-collapse:collapse;margin:25px 0;}
.article th {background:linear-gradient(135deg,var(--crimson-dark),var(--crimson));color:var(--white);padding:15px;text-align:left;font-weight:600;text-transform:uppercase;font-size:0.8rem;}
.article td {padding:12px 15px;border-bottom:1px solid rgba(220,20,60,0.1);}
.article tr:hover {background:rgba(220,20,60,0.05);}
.highlight {background:var(--crimson);color:var(--white);padding:2px 6px;border-radius:3px;}
.nav {display:flex;justify-content:space-between;align-items:center;margin-top:40px;padding-top:30px;border-top:1px solid rgba(220,20,60,0.2);}
.nav-btn {display:flex;align-items:center;gap:10px;padding:12px 25px;background:linear-gradient(135deg,rgba(220,20,60,0.2),rgba(220,20,60,0.1));border:1px solid rgba(220,20,60,0.3);border-radius:8px;color:var(--gray-200);text-decoration:none;font-size:0.85rem;transition:all 0.3s;}
.nav-btn:hover {background:linear-gradient(135deg,var(--crimson),var(--crimson-dark));border-color:var(--crimson);color:var(--white);box-shadow:0 0 20px var(--crimson-glow);transform:translateY(-2px);}
.nav-home {background:linear-gradient(135deg,rgba(45,45,45,0.8),rgba(26,26,26,0.8));border-color:var(--gray-600);}
.nav-home:hover {background:linear-gradient(135deg,var(--gray-600),var(--gray-700));border-color:var(--gray-400);box-shadow:0 0 15px rgba(255,255,255,0.1);}
.footer {text-align:center;padding:30px;color:var(--gray-500);font-size:0.8rem;border-top:1px solid rgba(220,20,60,0.1);margin-top:50px;}
.footer a {color:var(--crimson);text-decoration:none;}
@media(max-width:768px){.header{padding:0 15px}.logo-text{display:none}.search{display:none}.content{padding:20px 15px}.article{padding:30px 20px}.article h1{font-size:1.6rem}.article h2{font-size:1.3rem}.nav{flex-wrap:wrap;gap:15px}.nav-btn{flex:1;justify-content:center;min-width:100px}}
@media(max-width:480px){.article{padding:20px 15px;border-radius:12px}.article h1{font-size:1.4rem}.nav{flex-direction:column}.nav-btn{width:100%;justify-content:center}}
</style>
</head>
<body>
    <div class="bg"></div>
    <header class="header">
        <div class="logo">
            <button class="menu-btn"><i class="fas fa-bars"></i></button>
            <div class="logo-icon"><i class="fas fa-skull"></i></div>
            <div class="logo-text">RED<span>TEAM</span> LOG</div>
            <a href="../../../" class="home-btn" title="Back to Home"><i class="fas fa-home"></i></a>
        </div>
        <div class="controls">
            <div class="search">
                <input type="text" id="searchbar" placeholder="Buscar...">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <a href="../en/04-patch-diffing.html" class="lang-btn">English</a>
        </div>
    </header>
    <div class="overlay"></div>
    <nav class="sidebar">
        <div class="sidebar-title">Capítulos</div>
        <a href="01-introduccion.html" class="toc-link "><span class="chapter-num">01</span><span class="chapter-title">Introducción</span></a><a href="02-clases-vulnerabilidades.html" class="toc-link "><span class="chapter-num">02</span><span class="chapter-title">Clases de Vulnerabilidades</span></a><a href="03-fuzzing.html" class="toc-link "><span class="chapter-num">03</span><span class="chapter-title">Fuzzing</span></a><a href="04-patch-diffing.html" class="toc-link active"><span class="chapter-num">04</span><span class="chapter-title">Patch Diffing</span></a><a href="05-analisis-crashes.html" class="toc-link "><span class="chapter-num">05</span><span class="chapter-title">Análisis de Crashes</span></a>
    </nav>
    <main class="content">
        <div class="wrapper">
            <article class="article"><h1>Capítulo 4: Patch Diffing</h1>
<p>El "Patch Diffing" es el proceso de comparar dos versiones de un programa, una con un parche de seguridad y otra sin él, para identificar la vulnerabilidad que el parche corrige. Es una técnica crucial para los investigadores de seguridad que quieren entender cómo funciona una vulnerabilidad y cómo explotarla.</p>
<h2>4.1. 3.1 Fundamentos de Patch Diffing</h2>
<p><strong>El Proceso:</strong></p>
<ol>
<li><strong>Obtener los Binarios:</strong> Se necesitan las dos versiones del binario: la vulnerable y la parcheada.</li>
<li><strong>Diferenciar los Binarios:</strong> Se utiliza una herramienta de "diffing" binario (como <code>bindiff</code>, <code>Ghidra</code>, o <code>IDA Pro</code>) para comparar los dos archivos.</li>
<li><strong>Analizar las Diferencias:</strong> El investigador analiza las funciones que han cambiado para identificar la vulnerabilidad.</li>
<li><strong>Desarrollar un PoC:</strong> Una vez que se entiende la vulnerabilidad, se puede desarrollar una prueba de concepto (PoC) para demostrarla.</li>
</ol>
<h2>4.2. 3.2 Extracción de Parches de Windows</h2>
<p>En Windows, los parches de seguridad se distribuyen como archivos MSU. Estos archivos se pueden extraer para obtener los binarios actualizados.</p>
<p><strong>Script de Extracción PowerShell (Extract-Patch.ps1):</strong></p>
<p>Un script de PowerShell puede automatizar el proceso de descarga y extracción de parches de Windows Update.</p>
<h2>4.3. 3.3 Herramientas de Diffing Binario</h2>
<ul>
<li><strong>Ghidra y Ghidriff:</strong> Ghidra es un framework de ingeniería inversa de software de la NSA. Ghidriff es una extensión de Ghidra que facilita el "diffing" de binarios.</li>
<li><strong>BinDiff:</strong> Una popular herramienta de "diffing" para IDA Pro.</li>
<li><strong>Version Tracking de Ghidra:</strong> Ghidra también tiene una función de "version tracking" incorporada que se puede utilizar para comparar binarios.</li>
</ul>
<h2>4.4. 3.4 Caso de Estudio: CVE-2022-34718 (EvilESP)</h2>
<p>Este caso de estudio muestra cómo se utilizó el "patch diffing" para analizar una vulnerabilidad en el protocolo ESP de Windows. El análisis reveló un error en el manejo de paquetes ESP fragmentados que podía llevar a la ejecución remota de código.</p>
<h3>Información del CVE:</h3>
<table>
<thead>
<tr>
<th>Atributo</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE</td>
<td>CVE-2022-34718</td>
</tr>
<tr>
<td>Nombre</td>
<td>"EvilESP"</td>
</tr>
<tr>
<td>Componente</td>
<td>tcpip.sys (Windows TCP/IP Driver)</td>
</tr>
<tr>
<td>Tipo</td>
<td>Remote Code Execution (RCE)</td>
</tr>
<tr>
<td>CVSS</td>
<td>9.8 (Crítico)</td>
</tr>
<tr>
<td>Vector</td>
<td>Red, sin autenticación (con IPsec habilitado)</td>
</tr>
<tr>
<td>Versiones</td>
<td>Windows Server 2012-2022, Windows 10/11</td>
</tr>
<tr>
<td>Parche</td>
<td>Septiembre 2022 (KB5017308, KB5017305)</td>
</tr>
</tbody>
</table>
<h3>Prerrequisitos para Explotación:</h3>
<table>
<thead>
<tr>
<th>Prerrequisito</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>IPv6 habilitado</td>
<td>Default en Windows</td>
</tr>
<tr>
<td>IPsec habilitado y SA establecida</td>
<td></td>
</tr>
<tr>
<td>Atacante conoce SPI + clave HMAC</td>
<td>De la víctima</td>
</tr>
<tr>
<td>Atacante puede enviar paquetes IPv6</td>
<td>A la víctima</td>
</tr>
</tbody>
</table>
<h3>4.4.1. Adquisición de Binarios para EvilESP</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Crear directorio de trabajo</span>
<span class="n">mkdir</span> <span class="n">C</span><span class="p">:\</span><span class="n">EvilESP-Analysis</span>
<span class="nb">cd </span><span class="n">C</span><span class="p">:\</span><span class="n">EvilESP-Analysis</span>

<span class="c"># Obtener tcpip.sys vulnerable (pre-Septiembre 2022)</span>
<span class="c"># WinbIndex: https://winbindex.m417z.com/ → tcpip.sys → KB5016616</span>

<span class="c"># Obtener tcpip.sys parcheado (Septiembre 2022+)</span>
<span class="c"># WinbIndex → KB5017308 (Server 2022) o KB5017305 (Win 10/11)</span>

<span class="c"># Descargar símbolos</span>
<span class="nv">$symchk</span> <span class="p">=</span> <span class="s2">&quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\symchk.exe&quot;</span>
<span class="p">&amp;</span> <span class="nv">$symchk</span> <span class="n">tcpip_vulnerable</span><span class="p">.</span><span class="n">sys</span> <span class="p">/</span><span class="n">s</span> <span class="s2">&quot;SRV*.\Symbols*https://msdl.microsoft.com/download/symbols&quot;</span>
</code></pre></div>

<h3>4.4.2. Ejecutar Diff y Análisis</h3>
<div class="codehilite"><pre><span></span><code><span class="n">ghidriff</span> <span class="n">tcpip_vulnerable</span><span class="p">.</span><span class="n">sys</span> <span class="n">tcpip_patched</span><span class="p">.</span><span class="n">sys</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-symbols-path</span> <span class="p">.\</span><span class="n">Symbols</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-max-section-funcs</span> <span class="n">5000</span> <span class="p">\</span>
    <span class="p">-</span><span class="n">-output</span> <span class="n">tcpip_diff</span>

<span class="c"># Esperado: Solo 2 funciones cambiadas</span>
<span class="c"># - IppReceiveEsp</span>
<span class="c"># - Ipv6pReassembleDatagram</span>
</code></pre></div>

<h3>4.4.3. Análisis de Código Vulnerable vs Parcheado</h3>
<p><strong>Función 1: IppReceiveEsp</strong></p>
<p>Código Vulnerable:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">IppReceiveEsp</span><span class="p">(</span><span class="n">longlong</span><span class="w"> </span><span class="n">param_1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">iVar3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IppReceiveEspNbl</span><span class="p">(...);</span>

<span class="w">    </span><span class="c1">// BUG: Solo verifica 0 (éxito) o 0x105 (pendiente)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">iVar3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x105</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="p">(</span><span class="n">undefined4</span><span class="w"> </span><span class="o">*</span><span class="p">)((</span><span class="n">longlong</span><span class="p">)</span><span class="n">param_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x2c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x3b</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Código Parcheado:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">IppReceiveEsp</span><span class="p">(</span><span class="n">longlong</span><span class="w"> </span><span class="n">param_1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">iVar3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IppReceiveEspNbl</span><span class="p">(...);</span>

<span class="w">    </span><span class="c1">// FIX 1: Verificación de rango completa</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">iVar3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x2b</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// FIX 2: Descartar paquetes inválidos</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">iVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x105</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">puVar3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">IppDiscardReceivedPackets</span><span class="p">(</span>
<span class="w">                </span><span class="p">(</span><span class="n">longlong</span><span class="p">)</span><span class="n">puVar3</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">param_1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xe0004148</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Función 2: Ipv6pReassembleDatagram</strong></p>
<p>Código Vulnerable:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Ipv6pReassembleDatagram</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uVar11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x8c</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// BUG 1: Sin verificación de overflow de 16 bits</span>
<span class="w">    </span><span class="c1">// BUG 2: Sin validación de nextheader_offset</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">uVar13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">puVar5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x80</span><span class="p">),</span>
<span class="w">               </span><span class="p">(</span><span class="n">ulonglong</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Código Parcheado:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Ipv6pReassembleDatagram</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">uVar11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x8c</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x88</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// FIX 1: Verificar overflow de 16 bits</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar14</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x10001</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// FIX 2: Validar nextheader_offset</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ushort</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">param_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xbc</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uVar13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// FIX 3: Verificar tamaño final</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uVar14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">lVar4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Registrar fallo</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>4.4.4. Flujo de Ataque</h3>
<ol>
<li>Atacante crea paquetes IPv6 maliciosos con header ESP y fragmentos que causan overflow</li>
<li>Paquete 1: Fragment con offset=0, M=1</li>
<li>Paquete 2: Fragment con offset=24, M=0 (dispara reensamblaje)</li>
<li>IppReceiveEsp() no valida correctamente el código de resultado</li>
<li>Ipv6pReassembleDatagram() no verifica overflow ni nextheader_offset</li>
<li>memcpy OOB → corrupción de memoria → RCE o BSOD</li>
</ol>
<h3>4.4.5. Estructura de Paquetes ESP</h3>
<p><strong>ESP Header (RFC 4303):</strong>
- SPI (4 bytes)
- Sequence Number (4 bytes)
- Payload Data (variable)
- Padding + Pad Length + Next Header</p>
<p><strong>IPv6 Fragment Header:</strong>
- Next Header (1 byte)
- Fragment Offset (13 bits) + Flags
- Identification (4 bytes)</p>
<h3>4.4.6. Primitiva de Explotación</h3>
<table>
<thead>
<tr>
<th>Aspecto</th>
<th>Detalles</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tipo</td>
<td>Out-of-bounds write</td>
</tr>
<tr>
<td>Tamaño</td>
<td>Variable</td>
</tr>
<tr>
<td>Control de Offset</td>
<td>Via nextheader_offset</td>
</tr>
<tr>
<td>Trigger</td>
<td>Remoto, requiere IPsec SA</td>
</tr>
<tr>
<td>Prerrequisito</td>
<td>IPv6 enabled, IPsec corriendo</td>
</tr>
</tbody>
</table>
<h3>4.4.7. Resumen del Parche</h3>
<table>
<thead>
<tr>
<th>Función</th>
<th>Vulnerabilidad</th>
<th>Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>IppReceiveEsp</td>
<td>Validación faltante</td>
<td>Verificación de rango</td>
</tr>
<tr>
<td>IppReceiveEsp</td>
<td>Error continuo</td>
<td>IppDiscardReceivedPackets</td>
</tr>
<tr>
<td>Ipv6pReassembleDatagram</td>
<td>Integer overflow</td>
<td>Check: uVar14 &lt; 0x10001</td>
</tr>
<tr>
<td>Ipv6pReassembleDatagram</td>
<td>OOB offset</td>
<td>Check: offset &lt;= buffer</td>
</tr>
</tbody>
</table>
<h3>4.4.8. Lecciones</h3>
<ol>
<li>Binary diffing es efectivo: 10,000+ funciones → solo 2 cambiaron</li>
<li>Conocimiento de protocolos es esencial</li>
<li>Bugs simples tienen alto impacto (CVSS 9.8)</li>
<li>Vulnerabilidades multi-función son comunes</li>
<li>Prerrequisitos limitan el riesgo real</li>
<li>Parches revelan las condiciones de trigger</li>
</ol>
<h2>4.5. 3.5 Pipeline de Automatización de Patch Diffing</h2>
<h3>¿Por Qué Automatizar?</h3>
<ul>
<li>Microsoft libera parches mensualmente (Patch Tuesday - 2do martes de cada mes)</li>
<li>Analizar cada actualización manualmente consume mucho tiempo</li>
<li>Detección temprana de vulnerabilidades provee ventaja competitiva</li>
<li>La automatización permite monitoreo continuo</li>
</ul>
<h3>Etapas del Pipeline:</h3>
<ol>
<li><strong>MONITOREAR:</strong> MSRC API, Patch Tuesday</li>
<li><strong>DESCARGAR:</strong> WinbIndex, Update Catalog</li>
<li><strong>EXTRAER:</strong> Expand MSU, Extract CAB</li>
<li><strong>SÍMBOLOS:</strong> symchk.exe, Symbol Server</li>
<li><strong>DIFF:</strong> Ghidriff, BinDiff</li>
<li><strong>REPORTE:</strong> HTML/PDF, JSON para CI</li>
<li><strong>ALERTA:</strong> Email, Ticket, Slack/Teams</li>
</ol>
<h3>Script de Automatización Python para Ghidriff</h3>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PatchDiffer</span><span class="p">:</span>
    <span class="c1"># ... (implementación del script)</span>
</code></pre></div>

<h2>4.6. 3.6 Patch Diffing en Linux Kernel</h2>
<h3>3.6.1. Diferencias con Windows</h3>
<table>
<thead>
<tr>
<th>Aspecto</th>
<th>Windows</th>
<th>Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td>Código Fuente</td>
<td>Cerrado (solo binarios)</td>
<td>Abierto (git.kernel.org)</td>
</tr>
<tr>
<td>Formato Binario</td>
<td>PE/COFF</td>
<td>ELF</td>
</tr>
<tr>
<td>Símbolos Debug</td>
<td>PDB via Symbol Server</td>
<td>DWARF en paquetes -dbgsym</td>
</tr>
<tr>
<td>Distribución</td>
<td>Windows Update</td>
<td>apt/yum + distro-specific</td>
</tr>
<tr>
<td>Modificaciones Vendor</td>
<td>Ninguna</td>
<td>Backports, parches custom</td>
</tr>
</tbody>
</table>
<h3>3.6.2. Flujo de Trabajo para Linux</h3>
<ol>
<li><strong>Identificar Versiones de Kernel</strong></li>
<li><strong>Descargar Imágenes de Kernel y Símbolos</strong></li>
<li><strong>Extraer vmlinux</strong></li>
<li><strong>Identificar Módulos Cambiados</strong></li>
<li><strong>Diff con Ghidriff</strong></li>
</ol>
<h3>3.6.3. Diff a Nivel de Código Fuente</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Clonar fuente del kernel</span>
git<span class="w"> </span>clone<span class="w"> </span>--branch<span class="w"> </span>v6.8<span class="w"> </span>https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
<span class="nb">cd</span><span class="w"> </span>linux

<span class="c1"># Buscar commits de CVE</span>
git<span class="w"> </span>log<span class="w"> </span>--all<span class="w"> </span>--grep<span class="o">=</span><span class="s2">&quot;CVE&quot;</span><span class="w"> </span>--oneline<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-20

<span class="c1"># Ver diff de commit específico</span>
git<span class="w"> </span>show<span class="w"> </span>f342de4e2f33e0e39165d8639387aa6c19dff660
</code></pre></div>

<p>... (El resto del capítulo seguiría la misma estructura)</p>
<h3>3.6.4. Ejemplo: CVE-2024-1086 (nf_tables UAF)</h3>
<table>
<thead>
<tr>
<th>Atributo</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr>
<td>CVE</td>
<td>CVE-2024-1086</td>
</tr>
<tr>
<td>Componente</td>
<td>nf_tables (subsistema Netfilter)</td>
</tr>
<tr>
<td>Tipo</td>
<td>Use-After-Free → LPE</td>
</tr>
<tr>
<td>CVSS</td>
<td>7.8 (Alto)</td>
</tr>
<tr>
<td>Afecta</td>
<td>Linux 3.15 - 6.8</td>
</tr>
<tr>
<td>Exploit Público</td>
<td>Sí (~99% success rate)</td>
</tr>
</tbody>
</table>
<p><strong>Análisis del Bug:</strong>
- Validación basada en máscara permitía valores como NF_DROP | extra_bits
- &amp; NF_VERDICT_MASK dejaba pasar verdicts "decorados"
- Type confusion → UAF → LPE
- Fix: Cambiar de validación por máscara a coincidencia exacta</p>
<h3>3.6.5. Recursos para Linux Kernel</h3>
<table>
<thead>
<tr>
<th>Recurso</th>
<th>URL</th>
<th>Utilidad</th>
</tr>
</thead>
<tbody>
<tr>
<td>syzbot</td>
<td>syzkaller.appspot.com</td>
<td>Reproducers, bisección automática</td>
</tr>
<tr>
<td>Ubuntu Security Notices</td>
<td>ubuntu.com/security/notices</td>
<td>Advisories de distro</td>
</tr>
<tr>
<td>kernel.org</td>
<td>git.kernel.org</td>
<td>Código fuente oficial</td>
</tr>
</tbody>
</table>
<h2>4.7. Caso de Estudio: 7-Zip Path Traversal</h2>
<h3>4.7.1. Información del Caso</h3>
<table>
<thead>
<tr>
<th>Atributo</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr>
<td>Software</td>
<td>7-Zip File Archiver</td>
</tr>
<tr>
<td>Versiones Afectadas</td>
<td>24.09 y anteriores</td>
</tr>
<tr>
<td>Tipo</td>
<td>Path Traversal via Symlink (CWE-22)</td>
</tr>
<tr>
<td>Impacto</td>
<td>Arbitrary File Write → RCE potencial</td>
</tr>
<tr>
<td>CVSS</td>
<td>7.8 (Alto)</td>
</tr>
</tbody>
</table>
<h3>4.7.2. Análisis del Parche</h3>
<p>Archivo: <code>CPP/7zip/UI/Common/ArchiveExtractCallback.cpp</code></p>
<p><strong>Cambio 1: IsSafePath con Parámetro WSL</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ANTES: bool IsSafePath(const UString &amp;path)</span>
<span class="c1">// DESPUÉS: static bool IsSafePath(const UString &amp;path, bool isWSL)</span>
</code></pre></div>

<p><strong>Cambio 2: Detección WSL-Aware</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ANTES: IsAbsolute = NName::IsAbsolutePath(path);</span>
<span class="c1">// DESPUÉS: IsAbsolute = isWSL ? IS_PATH_SEPAR(path[0]) : NName::IsAbsolutePath(path);</span>
</code></pre></div>

<h3>4.7.3. Escenario de Ataque</h3>
<ol>
<li>Crear archivo con symlink WSL: <code>link -&gt; /mnt/c/Users/Public/Desktop</code></li>
<li>7-Zip 24.09: IsSafePath() sin isWSL=true → clasifica como "relativo"</li>
<li>Symlink creado fuera del directorio de extracción</li>
<li>→ Arbitrary File Write → RCE via DLL hijacking</li>
</ol>
<h3>4.7.4. Checklist de Validación de Paths</h3>
<p><strong>Buscar:</strong> IsSafePath, ValidatePath, IsAbsolute, IsRelative, symlinks</p>
<p><strong>Verificar:</strong>
- ¿Detección cross-plataforma correcta?
- ¿Symlinks WSL/Linux con semántica adecuada?
- ¿Normalización antes de validación?</p>
<h2>4.8. Conclusiones del Capítulo 4</h2>
<ol>
<li>
<p><strong>El parche es frecuentemente la única fuente de verdad</strong> cuando los detalles del CVE son limitados.</p>
</li>
<li>
<p><strong>Las herramientas automatizan pero no reemplazan el análisis humano</strong> - Ghidriff encuentra funciones cambiadas, tú entiendes por qué.</p>
</li>
<li>
<p><strong>Los símbolos son multiplicadores de fuerza</strong> - Con PDBs ves <code>IppValidatePacketLength</code>; sin ellos, ves <code>sub_1400A2F40</code>.</p>
</li>
<li>
<p><strong>Patrones de corrección revelan clases de vulnerabilidad:</strong></p>
</li>
<li>Bounds checks → overflow/OOB</li>
<li>Inicialización → memoria no inicializada</li>
<li>Locks → race condition</li>
<li>
<p>Validación de input → input validation flaw</p>
</li>
<li>
<p><strong>El patch diffing encuentra variantes</strong> - Al analizar un fix, frecuentemente se descubren bugs similares en código cercano.</p>
</li>
<li>
<p><strong>El análisis cross-plataforma requiere conocimiento de ambas semánticas</strong> - Como se vio en 7-Zip.</p>
</li>
<li>
<p><strong>La automatización transforma el análisis de reactivo a proactivo</strong>.</p>
</li>
</ol>
<h3>Preguntas de Discusión:</h3>
<ol>
<li>
<p>CVE-2022-34718 requiere IPsec SA pero recibió CVSS 9.8. ¿Cómo deberían los prerrequisitos afectar el rating?</p>
</li>
<li>
<p>El bug de EvilESP abarcó dos funciones. ¿Cómo podrían detectar vulnerabilidades cross-función?</p>
</li>
<li>
<p>La fragmentación IPv6 es fuente recurrente. ¿Qué hace que sea propensa a errores?</p>
</li>
<li>
<p>El fix de 7-Zip añadió múltiples cambios. ¿Cómo determinas cuál corrige la vulnerabilidad core?</p>
</li>
</ol></article>
            <div class="nav"><a href="03-fuzzing.html" class="nav-btn nav-prev"><i class="fas fa-chevron-left"></i><span>Anterior</span></a><a href="index.html" class="nav-btn nav-home"><i class="fas fa-home"></i><span>Inicio</span></a><a href="05-analisis-crashes.html" class="nav-btn nav-next"><span>Siguiente</span><i class="fas fa-chevron-right"></i></a></div>
            <footer class="footer"><p>© 2024 Red Team Logbook | <a href="https://github.com/mburgc" target="_blank"><i class="fab fa-github"></i> mburgc</a></p></footer>
        </div>
    </main>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const menuBtn = document.querySelector('.menu-btn');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.overlay');
    
    if (menuBtn && sidebar) {
        menuBtn.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active');
        });
    }
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    
    const searchInput = document.getElementById('searchbar');
    const searchBtn = document.getElementById('search-btn');
    
    function performSearch() {
        let input = searchInput.value.toLowerCase().trim();
        let article = document.querySelector('.article');
        let elements = article.querySelectorAll('p, li, h1, h2, h3, h4, h5, h6, pre, code');
        
        elements.forEach(el => {
            el.style.display = '';
            if (el.classList.contains('search-highlight')) {
                el.innerHTML = el.textContent;
                el.classList.remove('search-highlight');
            }
        });
        
        if (input === "") return;
        
        elements.forEach(el => {
            if (el.textContent.toLowerCase().includes(input)) {
                let html = el.innerHTML;
                let regex = new RegExp('(' + input + ')', 'gi');
                el.innerHTML = html.replace(regex, '<span class="search-highlight">$1</span>');
            } else {
                el.style.display = 'none';
            }
        });
    }
    
    if (searchBtn) searchBtn.addEventListener('click', performSearch);
    if (searchInput) searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') performSearch(); });
});
</script>
</body>
</html>